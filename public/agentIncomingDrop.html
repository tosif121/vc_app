<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />

    <title>Call Records</title>
    <meta content="" name="description" />
    <meta content="" name="keywords" />

    <!-- Favicons -->
    <link href="./img/favicon.png" rel="icon" />

    <!-- Google Fonts -->
    <link href="https://fonts.gstatic.com" rel="preconnect" />
    <link
      href="https://fonts.googleapis.com/css?family=https://fonts.googleapis.com/css?family=Poppins:300,300i,400,400i,500,500i,600,600i,700,700i"
      rel="stylesheet"
    />

    <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- pagination JQuery -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css" />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.datatables.net/buttons/2.1.1/css/buttons.dataTables.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.70/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.70/vfs_fonts.js"></script>

    <!-- Template Main CSS File -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
    <!-- Template Main CSS File -->
    <link href="assets/css/style.css" rel="stylesheet" />
  </head>

  <body>
    <section class="d-flex min-vh-100 flex-column">
      <header id="header" class="header sticky top-0 flex items-center justify-between">
        <div class="flex justify-between w-full items-center">
          <a href="agentdashBoard.html">
            <img src="./img/logo.png" alt="iotcom" class="w-56" />
          </a>

          <ul id="sidebar-nav" class="flex gap-10 me-10">
            <li class="">
              <a class="" href="agentdashBoard.html"> Dashboard </a>
            </li>
            <li class="">
              <a class="active" href="agentIncomingDrop.html"> Drop Calls </a>
            </li>
            <li class="">
              <a class="" href="agentcallData.html"> My Calls </a>
            </li>
            <!-- End Dashboard Nav -->
          </ul>
        </div>

        <div class="relative inline-block">
          <button class="py-2 px-4 rounded inline-flex items-center focus:outline-none" id="dropdown-btn">
            <img src="img/shiv.jpg" alt="Profile" class="rounded-full w-10 h-10" />
            <span class="d-none d-md-block dropdown-toggle ps-2" id="displayUsername"></span>
            <svg class="fill-current ml-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
              <path
                d="M10 12.586L4.293 6.879a1 1 0 0 0-1.414 1.414l6.364 6.364a1 1 0 0 0 1.414 0l6.364-6.364a1 1 0 0 0-1.414-1.414L10 12.586z"
              />
            </svg>
          </button>
          <div
            class="absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 transition-all duration-200 opacity-0 invisible"
            id="dropdown-menu"
          >
            <ul class="py-1 px-3" role="menu" aria-orientation="vertical" aria-labelledby="options-menu">
              <li class="py-3 border-b">
                <h6 id="displayUsername1">Shiv Shekhawat</h6>
                <span id="displayorg">Web Designer</span>
              </li>
              <li class="py-3 border-b">
                <i class="bi bi-person"></i>
                <span>My Profile</span>
              </li>
              <li class="py-3 border-b"><i class="bi bi-gear"></i> <span>Account Settings</span></li>
              <li class="py-3 border-b"><i class="bi bi-question-circle"></i> <span>Need Help?</span></li>
              <li class="py-3">
                <a class="dropdown-item d-flex align-items-center" href="#" onclick="signOut()">
                  <i class="bi bi-box-arrow-right"></i>
                  <span>Sign Out</span>
                </a>
              </li>
            </ul>
          </div>
        </div>
      </header>

      <main id="main" class="main flex-grow-1 m-8">
        <div class="bg-white shadow-sm p-4">
          <div class="flex justify-between">
            <h3 class="text-2xl mb-4 font-semibold">Call Drop Data</h3>
            <input
              type="text"
              class="form-control border rounded outline-0 focus:border-[#2196f3] focus:border cursor-pointer"
              id="date-range-picker"
              placeholder="Select Date Range"
            />
          </div>
          <div class="table-responsive rounded">
            <table class="table table-bordered" id="calldata">
              <thead class="thead">
                <tr>
                  <th>Caller</th>
                  <!-- <th>Dial No</th> -->
                  <!-- <th>Campaign</th> -->
                  <th>Call received on</th>
                  <!-- <th>Call answered</th> -->
                  <th>Call Disconnected</th>
                  <th>Duration</th>
                  <!-- <th>Agent</th> -->
                  <!-- <th>Disposition</th> -->
                  <!-- <th>Listen</th> -->
                </tr>
              </thead>
              <tbody>
                <!-- call records will be added dynamically -->
              </tbody>
            </table>
          </div>
        </div>
      </main>
      <!-- End #main -->

      <!-- ======= Footer ======= -->
      <footer id="footer" class="footer">
        <div class="copyright">
          &copy; Copyright <strong><span>iotcom</span></strong
          >. All Rights Reserved
        </div>
        <div class="credits">Designed by <a href="https://www.iotcom.io/">Iotcom</a></div>
      </footer>
    </section>
    <!-- End Footer -->

    <a href="#" class="back-to-top flex items-center justify-center"><i class="bi bi-arrow-up-short"></i></a>

    <!-- Date Range JS Files -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <!-- Include jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Include DataTables CSS -->

    <!-- Include DataTables JavaScript -->
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.1.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.1.1/js/buttons.html5.min.js"></script>

    <script>
      var campaignlist;
      let callDetails = []; // Declare userDetails outside the fetch function
      let filteredData = [];
      let StartDate;
      let EndDate;
      const agent = JSON.parse(localStorage.getItem('userinfo')).userid;

      const storedUsername = JSON.parse(localStorage.getItem('userinfo')).userid;
      const storedorg = JSON.parse(localStorage.getItem('userinfo')).adminuser;

      if (storedUsername) {
        document.getElementById('displayUsername').innerText = storedUsername;
        // document.getElementById('displayUsername1').innerText = storedUsername;
      } else {
        document.getElementById('displayorg').innerText = storedorg;
        document.getElementById('displayUsername').innerText = 'No stored username found.';
        // document.getElementById('displayUsernam1').innerText = 'No stored username found.';
      }

      document.addEventListener('DOMContentLoaded', async function () {
        //console.log("page startted");
        loadcallData();
      });

      // Initialize Flatpickr for date range selection
      flatpickr('#date-range-picker', {
        mode: 'range',
        dateFormat: 'Y-m-d',
        onChange: function (selectedDates, dateStr, instance) {
          StartDate = selectedDates[1];
          EndDate = selectedDates[0];
          if (StartDate !== null && EndDate !== null) {
            loadcallData(StartDate, EndDate);
          } else {
            console.log(StartDate, EndDate);
            console.log('select date properly');
          }
        },
      });

      async function loadcallData(StartDate, EndDate) {
        const currentdate = StartDate || new Date();
        var pastTimestamp = new Date().setDate(currentdate.getDate() - 1);
        const pastdate = EndDate || new Date(pastTimestamp);
        const Dateinterval = {
          startdate: new Date(currentdate),
          enddate: new Date(pastdate),
        };
        const formattedDates = {
          admin: storedorg,
          startdate: Dateinterval.enddate.toISOString().substring(0, 10),
          enddate: Dateinterval.startdate.toISOString().substring(0, 10),
        };

        fetch('https://devapp.iotcom.io/agentcallData', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${localStorage.getItem('jwtToken')}`,
          },
          body: JSON.stringify(formattedDates),
        })
          .then((response) => {
            if (response.status === 401) {
              // Unauthorized response handling: redirect to index page or handle as needed
              window.location.href = '/login.html'; // Replace with your index page URL
            } else if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            return response.json();
          })
          .then((data) => {
            callDetails = data.result;
            console.log(callDetails);

            if (callDetails !== null) {
              callDetails = callDetails.filter((x) => x.Type == 'incoming' && x.anstime == undefined);
              callDetails.sort((a, b) => {
                return b.startTime - a.startTime;
              });

              callDetails.forEach((entry) => {
                entry.duration = Math.floor((entry.hanguptime - entry.startTime) / 1000); // assuming both times are in milliseconds
                entry.hanguptime = formatDateTime(entry.hanguptime);
                entry.startTime = formatDateTime(entry.startTime);
                filteredData.push(entry);

                function formatDateTime(dateTimeString) {
                  if (dateTimeString) {
                    const istDate = new Date(dateTimeString);
                    const day = String(istDate.getDate()).padStart(2, '0');
                    const month = String(istDate.getMonth() + 1).padStart(2, '0');
                    const year = istDate.getFullYear();
                    const formattedDate = `${day}/${month}/${year}`;

                    const formattedTime = istDate.toLocaleString('en-US', {
                      timeZone: 'Asia/Kolkata',
                      hour: 'numeric',
                      minute: 'numeric',
                      second: 'numeric',
                      hour12: true,
                    });

                    const istDateFormat = `${formattedDate}\n\n\n${formattedTime}`;
                    return istDateFormat;
                  } else {
                    return 'NA';
                  }
                }
              });

              populatecalls(filteredData);
            }
          })
          .catch((error) => {
            console.error('Error fetching call details:', error);
          });
      }

      function populatecalls(filteredData) {
        console.log('populate calls');
        const table = document.getElementById('calldata').getElementsByTagName('tbody')[0];
        table.innerHTML = '';

        filteredData.forEach(function (call, index) {
          // Change 'file' to 'call'
          let newRow = table.insertRow(table.rows.length);
          // let cell1 = newRow.insertCell(0);
          // let cell2 = newRow.insertCell(1);
          // let cell3 = newRow.insertCell(2);
          // let cell4 = newRow.insertCell(3);
          // let cell5 = newRow.insertCell(4);
          // let cell6 = newRow.insertCell(5);
          // let cell7 = newRow.insertCell(6);
          // let cell8 = newRow.insertCell(7); // Fix the index here

          // cell1.textContent = call.Caller;
          // cell2.textContent = call.dialNumber;
          // cell3.textContent = call.campaign;
          // cell4.textContent = call.startTime;
          // cell5.textContent = call.anstime;
          // cell6.textContent = call.calldisconnecttime;
          // cell7.textContent = call.agent;

          const calldata = [
            call.Caller,
            //call.dialNumber,
            // call.campaign,
            call.startTime,
            // call.anstime,
            call.hanguptime,
            call.duration,
            // call.agent.split('@')[0],
            // call.Disposition?call.Disposition:"No Dispodone",
          ];
          for (i = 0; i < calldata.length; i++) {
            const cell = newRow.insertCell(i);
            cell.innerHTML = calldata[i] !== undefined ? calldata[i] : 'NA';
          }
        });
        $(document).ready(function () {
          $('#calldata').DataTable({
            dom: 'Blfrtip',
            buttons: ['copy', 'csv', 'excel', 'pdf', 'print'],
          });
        });
      }
      function signOut() {
        // Clear localStorage (optional)
        localStorage.removeItem('userinfo');
        localStorage.removeItem('jwtToken');

        // Redirect to the desired location
        window.location.href = '/login.html';
      }

      const dropdownBtn = document.getElementById('dropdown-btn');
      const dropdownMenu = document.getElementById('dropdown-menu');

      dropdownBtn.addEventListener('click', () => {
        dropdownMenu.classList.toggle('opacity-0');
        dropdownMenu.classList.toggle('invisible');
      });

      // Close the dropdown menu when clicking outside
      document.addEventListener('click', (event) => {
        if (!dropdownBtn.contains(event.target) && !dropdownMenu.contains(event.target)) {
          dropdownMenu.classList.add('opacity-0', 'invisible');
        }
      });
    </script>
    <!-- Vendor JS Files -->
    <script src="assets/vendor/tinymce/tinymce.min.js"></script>

    <!-- Template Main JS File -->
    <script src="assets/js/main.js"></script>
  </body>
</html>
