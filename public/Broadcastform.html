<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />

    <title>BroadCast From</title>
    <meta content="" name="description" />
    <meta content="" name="keywords" />

    <!-- Favicons -->
    <link href="./img/favicon.png" rel="icon" />

    <!-- Google Fonts -->
    <link href="https://fonts.gstatic.com" rel="preconnect" />
    <link
      href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i"
      rel="stylesheet"
    />

    <!-- Vendor CSS Files -->
    <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
    <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet" />

    <!-- Template Main CSS File -->
    <link href="assets/css/style.css" rel="stylesheet" />
  </head>

  <body>
    <section class="d-flex min-vh-100 flex-column">
      <header id="header" class="header sticky-top d-flex align-items-center">
        <div class="d-flex align-items-center justify-content-center">
          <a href="admindashboard.html" class="logo d-flex align-items-center">
            <img src="./img/logo.png" alt="iotcom" />
          </a>
        </div>
        <div class="ms-auto d-flex align-items-end">
          <div id="sidebar" class="sidebar me-5">
            <ul class="sidebar-nav d-flex gap-4" id="sidebar-nav">
              <li class="nav-item">
                <a class="nav-link" href="admindashboard.html">
                  <!-- <i class="bi bi-grid"></i> -->
                  <span>Dashboard</span>
                </a>
              </li>
              <!-- End Dashboard Nav -->

              <li class="nav-item">
                <a class="nav-link collapsed" data-bs-target="#icons-nav" data-bs-toggle="collapse" href="#">
                  <!-- <i class="bi bi-gem"></i> -->
                  <span>Users</span><i class="bi bi-chevron-down ms-2"></i>
                </a>
                <ul id="icons-nav" class="nav-content collapse" data-bs-parent="#sidebar-nav">
                  <li>
                    <a href="adduser.html"> <i class="bi bi-chevron-right"></i><span>Add New Users</span> </a>
                  </li>
                  <li>
                    <a href="userlist.html"> <i class="bi bi-chevron-right"></i><span>User List</span> </a>
                  </li>
                  <li>
                    <a href="AgentLoginHours.html">
                      <i class="bi bi-chevron-right"></i><span>Agent Login Hours</span>
                    </a>
                  </li>

                  <li>
                    <a href="Forcelogout.html">
                      <i class="bi bi-chevron-right"></i><span>Force Logout</span>
                    </a>
                  </li>
                </ul>
              </li>

              <!-- Broadcast Section -->
              <li class="nav-item">
                <a class="nav-link collapsed active" data-bs-target="#Broadcast-nav" data-bs-toggle="collapse" href="#">
                  <!-- <i class="bi bi-broadcast"></i> -->
                  <span>Broadcast</span><i class="bi bi-chevron-down ms-2"></i>
                </a>
                <ul id="Broadcast-nav" class="nav-content collapse" data-bs-parent="#sidebar-nav">
                  <li>
                    <a href="broadcast.html"> <i class="bi bi-chevron-right"></i><span>Add Broadcast</span> </a>
                  </li>
                  <li>
                    <a href="Broadcastform.html" class="active"> <i class="bi bi-chevron-right"></i><span>Upload Broadcast</span> </a>
                  </li>
                  <li>
                    <a href="broadCastReport.html">
                      <i class="bi bi-chevron-right"></i><span>Broadcast Report</span>
                    </a>
                  </li>
                  <li>
                    <a href="broadCastSummary.html">
                      <i class="bi bi-chevron-right"></i><span>Broadcast Summary</span>
                    </a>
                  </li>
                  <!-- Add more items as needed -->
                </ul>
              </li>

              <!-- campagian Section -->
              <li class="nav-item">
                <a class="nav-link collapsed" data-bs-target="#Campaign-nav" data-bs-toggle="collapse" href="#">
                  <!-- <i class="bi bi-layout-text-window-reverse"></i> -->
                  <span>Campaign</span><i class="bi bi-chevron-down ms-2"></i>
                </a>
                <ul id="Campaign-nav" class="nav-content collapse" data-bs-parent="#sidebar-nav">
                  <li>
                    <a href="newcampaign.html"> <i class="bi bi-chevron-right"></i><span>Add Campaign</span> </a>
                  </li>

                  <li>
                    <a href="form.html"> <i class="bi bi-chevron-right"></i><span>Upload Campaign</span> </a>
                  </li>
                  <li>
                    <a href="offlineCampaign.html"> <i class="bi bi-chevron-right"></i><span>Offline Campaign</span> </a>
                  </li>
                  <!-- Add more items as needed -->
                </ul>
              </li>
              <!-- End Blank Page Nav -->

              <li class="nav-item">
                <a class="nav-link collapsed" href="CallMenu.html">
                  <!-- <i class="bi bi-telephone-plus"></i> -->
                  <span>Call Menu</span>
                </a>
              </li>
              <!-- End Blank Page Nav -->

              <li class="nav-item">
                <a class="nav-link collapsed" href="AudioStore.html">
                  <!-- <i class="bi bi-file-earmark-music"></i> -->
                  <span>Audio Store</span>
                </a>
              </li>

              <li class="nav-item">
                <a class="nav-link collapsed" href="DID.html">
                  <!-- <i class="bi bi-card-list"></i> -->
                  <span>Add/Show DID</span>
                </a>
              </li>

              <li class="nav-item">
                <a class="nav-link collapsed" data-bs-target="#Data-nav" data-bs-toggle="collapse" href="#">
                  <span>Call Reports</span> <i class="bi bi-chevron-down ms-2"></i>
                </a>
                <ul id="Data-nav" class="nav-content collapse" data-bs-parent="#sidebar-nav">
                  <li>
                    <a href="aprReport.html">
                      <i class="bi bi-chevron-right"></i><span>Agent performance report</span>
                    </a>
                  </li>
                  <li>
                    <a href="calldata.html">
                      <i class="bi bi-chevron-right"></i><span>Call detail report</span>
                    </a>
                  </li>
                  <li>
                    <a href="IncomingCallData.html">
                      <i class="bi bi-chevron-right"></i><span>Incoming Call reports</span>
                    </a>
                  </li>

                  <li>
                    <a href="OutgoinfCallData.html">
                      <i class="bi bi-chevron-right"></i><span>Outgoing Call reports</span>
                    </a>
                  </li>
                  <li>
                    <a href="incomingDrop.html"> <i class="bi bi-chevron-right"></i><span>Drop Call reports</span> </a>
                  </li>
                  <!-- Add more items as needed -->
                </ul>
              </li>
            </ul>
          </div>

          <!-- End Logo -->

          <div class="search-bar" style="display: none">
            <form class="search-form d-flex align-items-center" method="POST" action="#">
              <input type="text" name="query" placeholder="Search" title="Enter search keyword" />
              <button type="submit" title="Search">
                <i class="bi bi-search"></i>
              </button>
            </form>
          </div>
          <!-- End Search Bar -->

          <nav class="header-nav ms-auto">
            <ul class="d-flex align-items-center">
              <li class="nav-item d-block d-lg-none">
                <a class="nav-link nav-icon search-bar-toggle" href="#" style="display: none">
                  <i class="bi bi-search"></i>
                </a>
              </li>
              <!-- End Search Icon-->

              <li class="nav-item dropdown pe-3">
                <a class="nav-link nav-profile d-flex align-items-center pe-0" href="#" data-bs-toggle="dropdown">
                  <img src="img/shiv.jpg" alt="Profile" class="rounded-circle" />
                  <span class="d-none d-md-block dropdown-toggle ps-2 text-capitalize" id="displayUsername"></span> </a
                ><!-- End Profile Iamge Icon -->

                <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow profile">
                  <li class="dropdown-header text-capitalize">
                    <h6 id="displayUsername1">Shiv Shekhawat</h6>
                    <span id="displayorg">Web Designer</span>
                  </li>
                  <li>
                    <hr class="dropdown-divider" />
                  </li>

                  <li>
                    <a class="dropdown-item d-flex align-items-center" href="users-profile.html">
                      <i class="bi bi-person"></i>
                      <span>My Profile</span>
                    </a>
                  </li>
                  <li>
                    <hr class="dropdown-divider" />
                  </li>

                  <li>
                    <a class="dropdown-item d-flex align-items-center" href="users-profile.html">
                      <i class="bi bi-gear"></i>
                      <span>Account Settings</span>
                    </a>
                  </li>
                  <li>
                    <hr class="dropdown-divider" />
                  </li>

                  <li>
                    <a class="dropdown-item d-flex align-items-center" href="pages-faq.html">
                      <i class="bi bi-question-circle"></i>
                      <span>Need Help?</span>
                    </a>
                  </li>
                  <li>
                    <hr class="dropdown-divider" />
                  </li>

                  <li>
                    <a class="dropdown-item d-flex align-items-center" href="#" onclick="signOut()">
                      <i class="bi bi-box-arrow-right"></i>
                      <span>Sign Out</span>
                    </a>
                  </li>
                </ul>
                <!-- End Profile Dropdown Items -->
              </li>
              <!-- End Profile Nav -->
            </ul>
          </nav>
        </div>
        <!-- End Icons Navigation -->
      </header>
      <!-- End Sidebar-->

      <main id="main" class="main flex-grow-1">
        <div class="container-fluid">
          <div class="bg-white shadow-sm rounded p-3 my-4 w-75 mx-auto">
            <h3 class="text-center">Broadcast Form</h3>
            <form action="#" id="form" class="p-3">
              <div class="mb-3">
                <select class="form-select shadow-none" id="campaign">
                  <!-- options dynamically added -->
                </select>
              </div>

              <div class="">
                <label for="file-input" class="form-label"> Choose Files To Upload </label>
                <input type="file" class="form-control shadow-none" id="file-input" multiple />
                <div class="mt-2" id="num-of-files">No Files Chosen</div>
                <ul class="list-group mt-2" id="files-list"></ul>
              </div>

              <div class="d-flex justify-content-center">
                <button type="submit" class="btn btn-primary">Submit</button>
              </div>
            </form>
          </div>
        </div>
        <div class="notification" id="EditMessage">
          <div class="notification-content">
            <p>Broadcast Upload Successfully!</p>
          </div>
        </div>
      </main>
      <!-- End #main -->

      <!-- ======= Footer ======= -->
      <footer id="footer" class="footer">
        <div class="copyright">
          &copy; Copyright <strong><span>iotcom</span></strong
          >. All Rights Reserved
        </div>
        <div class="credits">Designed by <a href="https://www.iotcom.io/">Iotcom</a></div>
      </footer>
    </section>
    <!-- End Footer -->

    <a href="#" class="back-to-top d-flex align-items-center justify-content-center"
      ><i class="bi bi-arrow-up-short"></i
    ></a>

    <!-- Vendor JS Files -->
    <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="assets/vendor/tinymce/tinymce.min.js"></script>

    <!-- Template Main JS File -->
    <script src="assets/js/main.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script>
      let fileInput = document.getElementById('file-input');
      let fileList = document.getElementById('files-list');
      let numOfFiles = document.getElementById('num-of-files');

      fileInput.addEventListener('change', () => {
        fileList.innerHTML = '';
        numOfFiles.textContent = `${fileInput.files.length} Files Selected`;

        for (i of fileInput.files) {
          let reader = new FileReader();
          let listItem = document.createElement('li');
          let fileName = i.name;
          let fileSize = (i.size / 1024).toFixed(1);
          listItem.innerHTML = `<p>${fileName}</p><p>${fileSize}KB</p>`;
          if (fileSize >= 1024) {
            fileSize = (fileSize / 1024).toFixed(1);
            listItem.innerHTML = `<p>${fileName}</p><p>${fileSize}MB</p>`;
          }
          fileList.appendChild(listItem);
        }
      });
    </script>

    <script>
      var finalData;
      const storedUsername = document.getElementById('displayUsername');
      const storedUsername1 = document.getElementById('displayUsername1');
      const storedorg = document.getElementById('displayorg');
      var campaignlist;

      async function fetchData() {
        try {
          const response = await fetch('/broadcastdetails', {
            headers: {
              Authorization: `Bearer ${localStorage.getItem('jwtToken')}`,
            },
          });

          if (response.status === 401) {
            // Unauthorized response handling: redirect to index page or handle as needed
            window.location.href = '/login.html'; // Replace with your index page URL
          } else {
            if (!response.ok) {
              throw new Error('Failed to fetch data');
            }

            const data1 = await response.json();
            const data = data1.result;
            campaignlist = data.map((campaign) => ({ name: campaign.BroadCastName, value: campaign.BroadCastId }));
          }
        } catch (error) {
          console.error('Error fetching data:', error);

          campaignlist = []; // Provide a default value in case of an error
        }
      }
      const campaignSelect = document.getElementById('campaign');
      // Use the async function to fetch data and then access campaignlist
      // document.getElementById('convert-btn').addEventListener('click', () => {
      //   const csvFileInput = document.getElementById('csv-file');
      //   const jsonResult = document.getElementById('json-result');

      //   if (csvFileInput.files.length === 0) {
      //     alert('Please select a CSV file');
      //     return;
      //   }

      //   const file = csvFileInput.files[0];

      //   Papa.parse(file, {
      //     header: true, // Treat the first row as headers
      //     dynamicTyping: true, // Automatically convert numeric values
      //     complete: function (results) {
      //       const jsonData = JSON.stringify(results.data, null, 2);
      //       jsonResult.innerHTML = `<pre>${jsonData}</pre>`;
      //     },
      //     error: function (error) {
      //       alert('An error occurred: ' + error.message);
      //     },
      //   });
      // });

      document.addEventListener('DOMContentLoaded', async function () {
        try {
          await fetchData();
          console.log(campaignlist);
        } catch (error) {
          console.error('Error:', error);
        }
        console.log(campaignlist);

        const storedUsername = JSON.parse(localStorage.getItem('admininfo')).user;
        const storedorg = JSON.parse(localStorage.getItem('admininfo')).organization;

        if (storedUsername) {
          document.getElementById('displayUsername').innerText = storedUsername;
          document.getElementById('displayUsername1').innerText = storedUsername;
          document.getElementById('displayorg').innerText = storedorg;
        } else {
          document.getElementById('displayUsername').innerText = 'No stored username found.';
          document.getElementById('displayUsernam1').innerText = 'No stored username found.';
        }

        campaignSelect.addEventListener('mouseover', () => updatecampaign(campaignlist));

        async function updatecampaign(campaignlist) {
          // Clear existing options
          campaignSelect.innerHTML = '<option value="" disabled selected>Select Broadcast</option>';

          // Generate new options based on selected supplier
          campaignlist.forEach((campaign) => {
            const option = document.createElement('option');
            option.class = 'form.select';
            option.value = campaign.value;
            option.text = campaign.name;
            campaignSelect.appendChild(option);
          });
        }
      });
      // function cvsparse() {
      //   let files = document.getElementById("file-input").files;
      //   //let fileName = files[0].lastModified+"_"+files[0].name
      //   let fileName = Date.now() + "_" + files[0].name
      //   let campaignName = document.getElementById("campaign").value
      //   console.log(campaignName);

      //   Papa.parse(files[0], {
      //     header: true,
      //     complete: function (results) {
      //       console.log("csv parsed")
      //       let mapround = 0
      //       finalData = results.data.map((x) => {
      //         x.leadId = Date.now().toString(36) + Math.random().toString(36).slice(2)
      //         x.lastDialedStatus = 'NA';
      //         x.state = 'new';
      //         x.filename = fileName;
      //         x.attemp = 0;
      //         x.campaignID = campaignName;
      //         //console.log(mapround)
      //         mapround++

      //         return x
      //       })
      //       console.log(finalData);

      //       fetch('/uploadata', {
      //         method: 'POST',
      //         headers: {
      //           'Content-Type': 'application/json',
      //         },
      //         //body: JSON.stringify(finalData),
      //         //body: JSON.stringify({data:finalData}),
      //         body: JSON.stringify(finalData),

      //       })
      //         .then((response) => response.text())
      //         .then((responseData) => {
      //           // you can do what ever you want here
      //           //console.log(responseData)
      //           console.log(responseData)
      //         })
      //     }
      //   });
      // }
      function cvsparse() {
        let files = document.getElementById('file-input').files;
        let fileName = Date.now() + '_' + files[0].name;
        let campaignName = document.getElementById('campaign').value;

        // Check if there are any files selected
        if (files.length === 0) {
          alert('No file selected for parsing.');
          return;
        }

        Papa.parse(files[0], {
          header: true,
          skipEmptyLines: true, // Skip empty lines during parsing
          complete: function (results) {
            // Check if there is any data to parse
            if (results.data.length === 0) {
              alert('No data in the CSV file to parse.');
              return;
            }

            // Get the headers from the CSV
            const headers = results.meta.fields;

            // Check if "name" and "number" headers are present
            const requiredHeaders = ['name', 'number'];
            const missingHeaders = requiredHeaders.filter((header) => !headers.includes(header));

            if (missingHeaders.length > 0) {
              alert(`Missing required headers: ${missingHeaders.join(', ')}`);
              return;
            }

            // Validate headers
            const invalidHeaders = headers.filter((header) => {
              // Check if the header contains uppercase letters or spaces
              return /[A-Z\s]/.test(header);
            });

            if (invalidHeaders.length > 0) {
              alert('Invalid headers found. Headers must be in lowercase without spaces: ' + invalidHeaders.join(', '));
              return;
            }

            let mapround = 0;

            const invalidNumberRows = [];

            finalData = results.data.map((x, index) => {
              //x.leadId = (index+Math.floor(Date.now()/1000)/10000000000).toFixed(11);
              x.lastDialedStatus = 0;
              x.state = 'new';
              x.filename = fileName;
              x.attempt = 0;
              x.BroadCastName = parseInt(campaignName, 10);

              // Trim and check if "number" is exactly 10 digits and composed of only numerical characters
              // const trimmedNumber = x.number.trim();
              // if (!/^\d{10}$/.test(trimmedNumber)) {
              //   invalidNumberRows.push(index + 1); // Add 1 to index for 1-based line numbers
              // }

              mapround++;
              return x;
            });

            // if (invalidNumberRows.length > 0) {
            //   alert("Invalid numbers found in rows: " + invalidNumberRows.join(', '));
            //   return;
            // }

            // Continue with the fetch and POST request
            fetch('/uploadata1', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${localStorage.getItem('jwtToken')}`,
              },
              body: JSON.stringify(finalData),
            })
              .then((response) => {
                if (response.status === 401) {
                  // Unauthorized response handling: redirect to index page or handle as needed
                  window.location.href = '/login.html'; // Replace with your index page URL
                } else {
                  return response.text();
                }
              })

              .then((responseData) => {
                // Handle the response
                // alert("Success: " + responseData);
                var notification = document.getElementById('EditMessage');
                notification.classList.add('show-notification');

                setTimeout(function () {
                  notification.classList.remove('show-notification');
                }, 1000);

                // Clear the form on success
                document.getElementById('file-input').value = '';
                document.getElementById('campaign').value = '';
              })
              .catch((error) => {
                // Handle fetch errors
                alert('Error: ' + error);
              });
          },
        });
      }

      const form = document.getElementById('form');
      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        cvsparse();
      });
      // function logout
      function signOut() {
        // Clear localStorage (optional)
        localStorage.removeItem('admininfo');
        localStorage.removeItem('jwtToken');
        localStorage.removeItem('didData');

        // Redirect to the desired location
        window.location.href = '/login.html';
      }
    </script>
  </body>
</html>
