<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />

    <title>Daily Login Reports</title>
    <meta content="" name="description" />
    <meta content="" name="keywords" />

    <!-- Favicons -->
    <link href="./img/favicon.png" rel="icon" />
    <!-- Google Fonts -->
    <link href="https://fonts.gstatic.com" rel="preconnect" />
    <link
      href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i"
      rel="stylesheet"
    />

    <!-- Vendor CSS Files -->
    <link
      href="assets/vendor/bootstrap/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="assets/vendor/bootstrap-icons/bootstrap-icons.css"
      rel="stylesheet"
    />

    <!-- pagination JQuery -->
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.datatables.net/buttons/2.1.1/css/buttons.dataTables.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.70/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.70/vfs_fonts.js"></script>

    <!-- Template Main CSS File -->
    <link href="assets/css/style.css" rel="stylesheet" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
    />
    <style>
      body {
        font-family: sans-serif;
      }

      /* start here date range */
      .date-range {
        background-color: #ffffff;
        max-width: 150px;
        box-shadow: 0px 0px 10px 0px rgba(0, 0, 0, 0.3);
        padding: 8px;
        border-radius: 10px;
      }

      .form-label {
        font-size: 8px;
        color: #000000;
      }

      .form-control {
        padding: 10px;
        font-size: 9px;
        border: 3px solid #225d97;
        border-radius: 5px;
      }

      /* end here date range */
      .container {
        background-color: #ffffff;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0px 0px 20px 0px rgba(0, 0, 0, 0.1);
      }

      h2 {
        color: #000000;
        text-align: center;
        /* text-transform: uppercase; */
      }

      .table th,
      .table td {
        text-align: center;
      }

      .table thead th {
        background-color: #225d97;
        color: #ffffff;
        border-color: #225d97;
      }

      .table tbody tr:hover {
        background-color: #f2f2f2;
      }

      .edit-btn,
      .delete-btn {
        border-radius: 15px;
        margin-right: 10px;
        /* Add margin between the buttons */
      }

      .btn-sm:hover {
        transform: scale(1.1);
      }

      .calendar-container {
        background-color: #ffffff;
        border-radius: 8px;
        box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        padding: 20px;
      }

      .calendar-container input[type="date"] {
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 14px;
      }

      .calendar-container input[type="submit"] {
        background-color: #225d97;
        color: #ffffff;
        border: none;
        padding: 6px 10px;
        font-size: 18px;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s;
      }
    </style>
  </head>

  <body>
    <!-- ======= Header ======= -->
    <header style="height: 70px;" id="header" class="header fixed-top d-flex align-items-center">
      <i class="bi bi-list toggle-sidebar-btn"></i>

      <div
        class="d-flex align-items-center justify-content-center"
        style="padding: 2vw"
      >
        <a href="admindashboard.html" class="logo d-flex align-items-center">
          <img src="./img/logo.png" alt="iotcom" />
        </a>
      </div>
      <!-- End Logo -->

      <div class="search-bar" style="display: none">
        <form
          class="search-form d-flex align-items-center"
          method="POST"
          action="#"
        >
          <input
            type="text"
            name="query"
            placeholder="Search"
            title="Enter search keyword"
          />
          <button type="submit" title="Search">
            <i class="bi bi-search"></i>
          </button>
        </form>
      </div>
      <!-- End Search Bar -->

      <nav class="header-nav ms-auto">
        <ul class="d-flex align-items-center">
          <li class="nav-item d-block d-lg-none">
            <a
              class="nav-link nav-icon search-bar-toggle"
              href="#"
              style="display: none"
            >
              <i class="bi bi-search"></i>
            </a>
          </li>
          <!-- End Search Icon-->

          <li class="nav-item dropdown pe-3">
            <a
              class="nav-link nav-profile d-flex align-items-center pe-0"
              href="#"
              data-bs-toggle="dropdown"
            >
              <img src="img/shiv.jpg" alt="Profile" class="rounded-circle" />
              <span
                class="d-none d-md-block dropdown-toggle ps-2"
                id="displayUsername"
              ></span> </a
            ><!-- End Profile Iamge Icon -->

            <ul
              class="dropdown-menu dropdown-menu-end dropdown-menu-arrow profile"
            >
              <li class="dropdown-header">
                <h6 id="displayUsername1">Shiv Shekhawat</h6>
                <span id="displayorg">Web Designer</span>
              </li>
              <li>
                <hr class="dropdown-divider" />
              </li>

              <li>
                <a
                  class="dropdown-item d-flex align-items-center"
                  href="users-profile.html"
                >
                  <i class="bi bi-person"></i>
                  <span>My Profile</span>
                </a>
              </li>
              <li>
                <hr class="dropdown-divider" />
              </li>

              <li>
                <a
                  class="dropdown-item d-flex align-items-center"
                  href="users-profile.html"
                >
                  <i class="bi bi-gear"></i>
                  <span>Account Settings</span>
                </a>
              </li>
              <li>
                <hr class="dropdown-divider" />
              </li>

              <li>
                <a
                  class="dropdown-item d-flex align-items-center"
                  href="pages-faq.html"
                >
                  <i class="bi bi-question-circle"></i>
                  <span>Need Help?</span>
                </a>
              </li>
              <li>
                <hr class="dropdown-divider" />
              </li>

              <li>
                <a
                  class="dropdown-item d-flex align-items-center"
                  href="#"
                  onclick="signOut()"
                >
                  <i class="bi bi-box-arrow-right"></i>
                  <span>Sign Out</span>
                </a>
              </li>
            </ul>
            <!-- End Profile Dropdown Items -->
          </li>
          <!-- End Profile Nav -->
        </ul>
      </nav>
      <!-- End Icons Navigation -->
    </header>

    <main style="margin-top: 150px;" id="main" class="flex-grow-1">
      <div class="container-fluid">
        <div class="p-3 m-2 bg-white shadow-sm rounded-1">
          <div class="d-flex align-items-center justify-content-between">
            <h3 class="text-center mb-4">Daily Login Data</h3>
              <div class="position-relative">
                <input
                type="text"
                class="form-control flatpickr-input"
                id="date-range-picker"
                placeholder="Select Date Range"
              />
              </div>
          </div>
          <div class="table-responsive rounded">
            <table class="table table-bordered" id="table">
              <thead class="thead">
                <tr>
                  <th>Agent</th>
                  <th>Date</th>
                  <th>Total Calls</th>
                  <th>Waiting for Call</th>
                  <th>ON Call</th>
                  <th>Disposition Time</th>
                  <th>Training Break</th>
                  <th>LunchBreak</th>
                  <th>TeaBreak</th>
                  <th>Break Time</th>
                  <th>Hold Time</th>
                  <th>Total Login Time</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                <!-- data will be added dynamically -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Modal -->
      <div class="modal" id="myModal">
        <div class="modal-dialog">
          <div class="modal-content">
            <!-- Modal Body -->
            <div class="modal-body">
              <table class="table" id="modaltable">
                <thead>
                  <tr>
                    <th>Action Type</th>
                    <th>Time</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </main>
    <!-- End #main -->

    <!-- ======= Footer ======= -->
    <footer id="footer" class="footer">
      <div class="copyright">
        &copy; Copyright <strong><span>iotcom</span></strong
        >. All Rights Reserved
      </div>
      <div class="credits">
        Designed by <a href="https://www.iotcom.io/">Iotcom</a>
      </div>
    </footer>
    <!-- End Footer -->

    <a
      href="#"
      class="back-to-top d-flex align-items-center justify-content-center"
      ><i class="bi bi-arrow-up-short"></i
    ></a>
    <!-- Date Range JS Files -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <!-- Include jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Include DataTables CSS -->
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css"
    />

    <!-- Include DataTables JavaScript -->
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.1.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.1.1/js/buttons.html5.min.js"></script>
    <script>
      const storedUsername = document.getElementById("displayUsername");
      const storedUsername1 = document.getElementById("displayUsername1");
      const storedorg = document.getElementById("displayorg");
      var detaileddata = {};
      var StartDate;
      var EndDate;

      document.addEventListener("DOMContentLoaded", function () {
        ALH();
        const storedUsername = JSON.parse(
          localStorage.getItem("admininfo")
        ).user;
        const storedorg = JSON.parse(
          localStorage.getItem("admininfo")
        ).organization;

        if (storedUsername) {
          document.getElementById("displayUsername").innerText = storedUsername;
          document.getElementById("displayUsername1").innerText =
            storedUsername;
          document.getElementById("displayorg").innerText = storedorg;
        } else {
          document.getElementById("displayUsername").innerText =
            "No stored username found.";
          document.getElementById("displayUsernam1").innerText =
            "No stored username found.";
        }
      });

      // Initialize Flatpickr for date range selection
      flatpickr("#date-range-picker", {
        mode: "range",
        dateFormat: "Y-m-d",
        onChange: function (selectedDates, dateStr, instance) {
          StartDate = selectedDates[1];
          EndDate = selectedDates[0];
          if (StartDate !== null && EndDate !== null) {
            console.log(StartDate, EndDate);
            const currentDate = new Date(StartDate);
            const year = currentDate.getFullYear();
            const month = String(currentDate.getMonth() + 1).padStart(2, "0"); // January is 0!
            const day = String(currentDate.getDate()).padStart(2, "0");
            const formattedDate1 = `${year}-${month}-${day}`;
            const currentDate1 = new Date(EndDate);
            const year1 = currentDate1.getFullYear();
            const month1 = String(currentDate1.getMonth() + 1).padStart(2, "0"); // January is 0!
            const day1 = String(currentDate1.getDate()).padStart(2, "0");
            const formattedDate2 = `${year1}-${month1}-${day1}`;
            console.log(formattedDate1, formattedDate2);

            ALH(formattedDate2, formattedDate1);
          } else {
            console.log(StartDate, EndDate);
            console.log("select date properly");
          }
        },
      });

      function ALH(a, b) {
        if (a && b) {
          // If user selected a date, use the selected date
          dateobj = {
            startdate: a,
            starttime: "00:00:00",
            enddate: b,
            endtime: "23:59:59",
          };
        } else {
          // If user did not select a date, use the current date
          let currentDate = new Date();
          let year = currentDate.getFullYear();
          let month = String(currentDate.getMonth() + 1).padStart(2, "0"); // January is 0!
          let day = String(currentDate.getDate()).padStart(2, "0");
          let formattedDate = `${year}-${month}-${day}`;

          dateobj = {
            startdate: formattedDate,
            starttime: "00:00:00",
            enddate: formattedDate,
            endtime: "23:59:59",
          };
        }
        const url = "/agentlogindata";

        fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${localStorage.getItem("jwtToken")}`,
          },
          body: JSON.stringify(dateobj),
        })
          .then((Response) => {
            if (Response.status === 401) {
              // Unauthorized response handling: redirect to index page or handle as needed
              window.location.href = "/login.html"; // Replace with your index page URL
            } else {
              return Response.json();
            }
          })
          .then((s) => {
            const rawData = s.result || [];
            detaileddata = {};

            if (rawData.length > 0) {
              const filterData = rawData.filter(
                (a) => a.Status !== "RINGING" && a.Status !== "RINGINUSE"
              );
              // Create an object to store separate arrays for each user
              const userArrays = {};

              // Iterate through the data and organize it by user
              // Iterate through each item in filterData
              filterData.forEach((item) => {
                const user = item.user;
                const epochTime = item.Time;

                // Convert epoch time to a date string (YYYY-MM-DD)
                const dateKey = new Date(epochTime).toISOString().slice(0, 10);

                // Check if userArrays for the user doesn't exist, create empty arrays
                if (!userArrays[user]) {
                  userArrays[user] = {};
                  detaileddata[user] = {};
                }

                // Check if the array for the date exists, if not, create a new one
                if (!userArrays[user][dateKey]) {
                  userArrays[user][dateKey] = [];
                  detaileddata[user][dateKey] = [];
                }

                // Push the item to the respective user and date array
                userArrays[user][dateKey].push(item);
                detaileddata[user][dateKey].push(item);
              });

              console.log(detaileddata);
              console.log(userArrays);
              const userSummaryArray = [];
              for (const user in userArrays) {
                if (userArrays.hasOwnProperty(user)) {
                  const userDataByDate = userArrays[user];

                  for (const date in userDataByDate) {
                    if (userDataByDate.hasOwnProperty(date)) {
                      let userData = userDataByDate[date];
                      //console.log(userData);
                      let newarray = [];

                      for (let a = 0; a < userData.length - 1; a++) {
                        const startingStatus = userData[a].Status;
                        const endStatus = userData[a + 1].Status;
                        const startTime = new Date(userData[a].Time).getTime();
                        const endTime = new Date(
                          userData[a + 1].Time
                        ).getTime();
                        const duration = endTime - startTime;
                        const subType = userData[a].Type;

                        const Data = {
                          startingStatus,
                          endStatus,
                          duration,
                          subType,
                          Action: action(startingStatus, endStatus),
                        };

                        newarray.push(Data);
                      }
                      userData = newarray;

                      const summary = {
                        user,
                        date,
                        TotalCalls: 0,
                        waitingforcall: 0,
                        oncall: 0,
                        break: 0,
                        disposition: 0,
                        totallogintime: 0,
                        hold: 0,
                        TeaBreak: 0,
                        LunchBreak: 0,
                        TrainingBreak: 0,
                      };

                      userData.forEach((data) => {
                        if (data.Action === "WaitingForCall") {
                          summary.waitingforcall += data.duration;
                        } else if (data.Action === "OnCall") {
                          summary.TotalCalls += 1;
                          summary.oncall += data.duration;
                        } else if (data.Action === "Disposition") {
                          summary.disposition += data.duration;
                        } else if (data.Action === "Offline") {
                          summary.offline += data.duration;
                        } else if (data.Action === "Hold") {
                          summary.hold += data.duration;
                        } else {
                          summary.break += data.duration;
                          if (data.subType === "TrainingBreak") {
                            summary.TrainingBreak += data.duration;
                          } else if (data.subType === "LunchBreak") {
                            summary.LunchBreak += data.duration;
                          } else {
                            summary.TeaBreak += data.duration;
                          }
                        }

                        summary.totallogintime =
                          summary.waitingforcall +
                          summary.oncall +
                          summary.disposition;
                      });

                      // Convert durations to "h:m:s" format
                      summary.waitingforcall = msToHMS(summary.waitingforcall);
                      summary.oncall = msToHMS(summary.oncall);
                      summary.break = msToHMS(summary.break);
                      summary.disposition = msToHMS(summary.disposition);
                      summary.totallogintime = msToHMS(summary.totallogintime);
                      summary.hold = msToHMS(summary.hold);
                      summary.TeaBreak = msToHMS(summary.TeaBreak);
                      summary.LunchBreak = msToHMS(summary.LunchBreak);
                      summary.TrainingBreak = msToHMS(summary.TrainingBreak);
                      console.log(summary);

                      // Push summary to userSummaryArray
                      userSummaryArray.push(summary);
                    }
                  }
                }
              }

              console.log(userSummaryArray);
              populateagent(userSummaryArray);
            } else {
              populateagent([]);
            }
          });
      }

      function populatedetailed(userData) {
        console.log("populatedetailed");
        const table = document
          .getElementById("modaltable")
          .getElementsByTagName("tbody")[0];
        table.innerHTML = "";

        userData.forEach(function (call) {
          let newRow = table.insertRow(table.rows.length);
          let cell1 = newRow.insertCell(0);
          let cell2 = newRow.insertCell(1);
          let cell3 = newRow.insertCell(2);

          // Assuming call object properties exist and match the cell positions
          cell1.textContent = call.Type || "-";
          cell2.textContent = formatDateTime(call.Time) || "-";
          cell3.textContent = call.Status || "-";
        });
      }

      function formatDateTime(dateTimeString) {
        const istDate = new Date(dateTimeString);
        const day = String(istDate.getDate()).padStart(2, "0");
        const month = String(istDate.getMonth() + 1).padStart(2, "0");
        const year = istDate.getFullYear();
        const formattedDate = `${day}/${month}/${year}`;

        const formattedTime = istDate.toLocaleString("en-US", {
          timeZone: "Asia/Kolkata",
          hour: "numeric",
          minute: "numeric",
          second: "numeric",
          hour12: true,
        });

        const istDateFormat = `${formattedDate}\n\n\n${formattedTime}`;
        return istDateFormat;
      }

      function populateagent(userSummaryArray) {
        var Dttable = $("#table").DataTable();
        Dttable.destroy();
        console.log("populateagent");
        const table = document
          .getElementById("table")
          .getElementsByTagName("tbody")[0];
        table.innerHTML = "";
        if (userSummaryArray.length > 0) {
          userSummaryArray.forEach(function (call) {
            let newRow = table.insertRow(table.rows.length);
            let cell1 = newRow.insertCell(0);
            let cell2 = newRow.insertCell(1);
            let cell3 = newRow.insertCell(2);
            let cell4 = newRow.insertCell(3);
            let cell5 = newRow.insertCell(4);
            let cell6 = newRow.insertCell(5);
            let cell7 = newRow.insertCell(6);
            let cell8 = newRow.insertCell(7);
            let cell9 = newRow.insertCell(8);
            let cell10 = newRow.insertCell(9);
            let cell11 = newRow.insertCell(10);
            let cell12 = newRow.insertCell(11);
            let cell13 = newRow.insertCell(12);

            // Assuming call object properties exist and match the cell positions
            cell1.textContent = call.user;
            cell2.textContent = call.date;
            cell3.textContent = call.TotalCalls;
            cell4.textContent = call.waitingforcall;
            cell5.textContent = call.oncall;
            cell6.textContent = call.disposition;
            cell7.textContent = call.TrainingBreak;
            cell8.textContent = call.LunchBreak;
            cell9.textContent = call.TeaBreak;
            cell10.textContent = call.break;
            cell11.textContent = call.hold;
            cell12.textContent = call.totallogintime;

            // Create a button element and set its class and innerHTML
            let actionButton = document.createElement("button");
            actionButton.className = "btn btn-success";
            actionButton.innerHTML =
              '<i class="bi bi-clipboard2-data-fill"></i>';
            actionButton.setAttribute("data-bs-toggle", "modal");
            actionButton.setAttribute("data-bs-target", "#myModal");

            // Append the button to the 8th cell
            cell13.appendChild(actionButton);
            actionButton.addEventListener("click", function () {
              populatedetailed(detaileddata[call.user][call.date]);
            });
          });
        }
        $(document).ready(function () {
          $("#table").DataTable({
            dom: "Blfrtip",
            buttons: ["copy", "csv", "excel", "pdf", "print"],
            order: [
                  [1, 'desc'] // Column index 2 (zero-based) sorted in descending order
                 ]
          });
        });
      }

      function action(a, b) {
        let Action;
        if (a === "UNAVAILABLE") {
          Action = "Offline";
        } else if (a === "Disposition") {
          Action = "Disposition";
        } else if (a === "NOT_INUSE") {
          Action = "WaitingForCall";
        } else if (a === "INUSE") {
          Action = "OnCall";
        } else {
          Action = "Invalid";
        }
        return Action;
      }

      // Function to convert milliseconds to "h:m:s" format
      function msToHMS(duration) {
        const seconds = Math.floor((duration / 1000) % 60);
        const minutes = Math.floor((duration / (1000 * 60)) % 60);
        const hours = Math.floor((duration / (1000 * 60 * 60)) % 24);
        return `${hours}h ${minutes}m ${seconds}s`;
      }
      function signOut() {
        // Clear localStorage (optional)
        localStorage.removeItem("admininfo");
        localStorage.removeItem("jwtToken");
        localStorage.removeItem("didData");

        // Redirect to the desired location
        window.location.href = "/login.html";
      }
    </script>

    <!-- Vendor JS Files -->
    <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="assets/vendor/tinymce/tinymce.min.js"></script>

    <!-- Template Main JS File -->
    <script src="assets/js/main.js"></script>
  </body>
</html>
