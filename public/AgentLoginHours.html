<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />

    <title>Daily Login Reports</title>
    <meta content="" name="description" />
    <meta content="" name="keywords" />

    <!-- Favicons -->
    <link href="./img/favicon.png" rel="icon" />
    <!-- Google Fonts -->
    <link href="https://fonts.gstatic.com" rel="preconnect" />
    <link
        href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i"
        rel="stylesheet" />

    <!-- Vendor CSS Files -->
    <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
    <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet" />

    <!-- <link href="assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
  <link href="assets/vendor/quill/quill.snow.css" rel="stylesheet">
  <link href="assets/vendor/quill/quill.bubble.css" rel="stylesheet">
  <link href="assets/vendor/remixicon/remixicon.css" rel="stylesheet">
  <link href="assets/vendor/simple-datatables/style.css" rel="stylesheet"> -->

    <!-- Template Main CSS File -->
    <link href="assets/css/style.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
    <style>
        body {
            font-family: sans-serif;
        }

        /* start here date range */
        .date-range {
            background-color: #ffffff;
            max-width: 150px;
            box-shadow: 0px 0px 10px 0px rgba(0, 0, 0, 0.3);
            padding: 8px;
            border-radius: 10px;
        }

        .form-label {
            font-size: 8px;
            color: #000000;
        }

        .form-control {
            padding: 10px;
            font-size: 9px;
            border: 3px solid #225d97;
            border-radius: 5px;
        }

        /* end here date range */
        .container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0px 0px 20px 0px rgba(0, 0, 0, 0.1);
        }

        h2 {
            color: #000000;
            text-align: center;
            /* text-transform: uppercase; */
        }

        .table th,
        .table td {
            text-align: center;
        }

        .table thead th {
            background-color: #225d97;
            color: #ffffff;
            border-color: #225d97;
        }


        .table tbody tr:hover {
            background-color: #f2f2f2;
        }

        .edit-btn,
        .delete-btn {
            border-radius: 15px;
            margin-right: 10px;
            /* Add margin between the buttons */
        }

        .btn-sm:hover {
            transform: scale(1.1);
        }

        .calendar-container {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }


        .calendar-container input[type="date"] {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
        }

        .calendar-container input[type="submit"] {
            background-color: #225d97;
            color: #ffffff;
            border: none;
            padding: 6px 10px;
            font-size: 18px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
    </style>
</head>

<body>
    <!-- ======= Header ======= -->
    <header id="header" class="header fixed-top d-flex align-items-center">
        <i class="bi bi-list toggle-sidebar-btn"></i>

        <div class="d-flex align-items-center justify-content-center" style="padding: 2vw">
            <a href="admindashboard.html" class="logo d-flex align-items-center">
                <img src="./img/logo.png" alt="iotcom" />
            </a>
        </div>
        <!-- End Logo -->

        <div class="search-bar" style="display: none">
            <form class="search-form d-flex align-items-center" method="POST" action="#">
                <input type="text" name="query" placeholder="Search" title="Enter search keyword" />
                <button type="submit" title="Search">
                    <i class="bi bi-search"></i>
                </button>
            </form>
        </div>
        <!-- End Search Bar -->

        <nav class="header-nav ms-auto">
            <ul class="d-flex align-items-center">
                <li class="nav-item d-block d-lg-none">
                    <a class="nav-link nav-icon search-bar-toggle" href="#" style="display: none">
                        <i class="bi bi-search"></i>
                    </a>
                </li>
                <!-- End Search Icon-->

                <li class="nav-item dropdown pe-3">
                    <a class="nav-link nav-profile d-flex align-items-center pe-0" href="#" data-bs-toggle="dropdown">
                        <img src="img/shiv.jpg" alt="Profile" class="rounded-circle" />
                        <span class="d-none d-md-block dropdown-toggle ps-2" id="displayUsername"></span>
                    </a><!-- End Profile Iamge Icon -->

                    <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow profile">
                        <li class="dropdown-header">
                            <h6 id="displayUsername1">Shiv Shekhawat</h6>
                            <span id="displayorg">Web Designer</span>
                        </li>
                        <li>
                            <hr class="dropdown-divider" />
                        </li>

                        <li>
                            <a class="dropdown-item d-flex align-items-center" href="users-profile.html">
                                <i class="bi bi-person"></i>
                                <span>My Profile</span>
                            </a>
                        </li>
                        <li>
                            <hr class="dropdown-divider" />
                        </li>

                        <li>
                            <a class="dropdown-item d-flex align-items-center" href="users-profile.html">
                                <i class="bi bi-gear"></i>
                                <span>Account Settings</span>
                            </a>
                        </li>
                        <li>
                            <hr class="dropdown-divider" />
                        </li>

                        <li>
                            <a class="dropdown-item d-flex align-items-center" href="pages-faq.html">
                                <i class="bi bi-question-circle"></i>
                                <span>Need Help?</span>
                            </a>
                        </li>
                        <li>
                            <hr class="dropdown-divider" />
                        </li>

                        <li>
                            <a class="dropdown-item d-flex align-items-center" href="#" onclick="signOut()">
                                <i class="bi bi-box-arrow-right"></i>
                                <span>Sign Out</span>
                            </a>
                        </li>
                    </ul>
                    <!-- End Profile Dropdown Items -->
                </li>
                <!-- End Profile Nav -->
            </ul>
        </nav>
        <!-- End Icons Navigation -->
    </header>
    <!-- End Header -->


    <!-- ======= Sidebar ======= -->
    <aside id="sidebar" class="sidebar">
        <ul class="sidebar-nav" id="sidebar-nav">
          <li class="nav-item">
            <a class="nav-link" href="admindashboard.html">
              <i class="bi bi-grid"></i>
              <span>Dashboard</span>
            </a>
          </li>
          <!-- End Dashboard Nav -->
    
          <li class="nav-item">
            <a class="nav-link collapsed" data-bs-target="#icons-nav" data-bs-toggle="collapse" href="#">
              <i class="bi bi-gem"></i><span>Users</span><i class="bi bi-chevron-down ms-auto"></i>
            </a>
            <ul id="icons-nav" class="nav-content collapse" data-bs-parent="#sidebar-nav">
              <li>
                <a href="adduser.html">
                  <i class="bi bi-circle"></i><span>Add New Users</span>
                </a>
              </li>
              <li>
                <a href="userlist.html">
                  <i class="bi bi-circle"></i><span>User List</span>
                </a>
              </li>
              <li>
                <a href="AgentLoginHours.html">
                  <i class="bi bi-circle"></i><span>Agent Login Hours</span>
                </a>
              <li>
                <a href="Forcelogout.html">
                  <i class="bi bi-circle"></i><span>Force Logout</span>
                </a>
              </li>
            </ul>
          </li>
    
          <!-- Broadcast Section -->
          <li class="nav-item">
            <a class="nav-link collapsed" data-bs-target="#Broadcast-nav" data-bs-toggle="collapse" href="#">
              <i class="bi bi-broadcast"></i><span>Broadcast</span><i class="bi bi-chevron-down ms-auto"></i>
            </a>
            <ul id="Broadcast-nav" class="nav-content collapse" data-bs-parent="#sidebar-nav">
              <li>
                <a href="broadcast.html">
                  <i class="bi bi-circle"></i><span>Add Broadcast</span>
                </a>
              </li>
              <li>
                <a href="Broadcastform.html">
                  <i class="bi bi-circle"></i><span>Upload Broadcast</span>
                </a>
              </li>
              <li>
                <a href="broadCastReport.html">
                  <i class="bi bi-circle"></i><span>BroadCast Report</span>
                </a>
              </li>
              <li>
                <a href="broadCastSummary.html">
                  <i class="bi bi-circle"></i><span>BroadCast Summary</span>
                </a>
              </li>
              <!-- Add more items as needed -->
            </ul>
          </li>
    
          <!-- campagian Section -->
          <li class="nav-item">
            <a class="nav-link collapsed" data-bs-target="#Campaign-nav" data-bs-toggle="collapse" href="#">
              <i class="bi bi-layout-text-window-reverse"></i><span>Campaign</span><i
                class="bi bi-chevron-down ms-auto"></i>
            </a>
            <ul id="Campaign-nav" class="nav-content collapse" data-bs-parent="#sidebar-nav">
    
              <li>
                <a href="newcampaign.html">
                  <i class="bi bi-circle"></i><span>Add Campaign</span>
                </a>
              </li>
    
              <li>
                <a href="form.html">
                  <i class="bi bi-circle"></i><span>Upload Campaign</span>
                </a>
              </li>
              <!-- Add more items as needed -->
            </ul>
          </li>
          <!-- End Blank Page Nav -->
    
          <li class="nav-item">
            <a class="nav-link collapsed" href="CallMenu.html">
              <i class="bi bi-telephone-plus"></i>
              <span>Call Menu</span>
            </a>
          </li>
          <!-- End Blank Page Nav -->
    
          <li class="nav-item">
            <a class="nav-link collapsed" href="AudioStore.html">
              <i class="bi bi-file-earmark-music"></i>
              <span>Audio Store</span>
            </a>
          </li>
    
          <li class="nav-item">
            <a class="nav-link collapsed" href="DID.html">
              <i class="bi bi-card-list"></i>
              <span>Add/Show DID</span>
            </a>
          </li>
    
          <li class="nav-item">
            <a class="nav-link collapsed" data-bs-target="#Data-nav" data-bs-toggle="collapse" href="#">
              <i class="bi bi-database-check"></i></i><span>Call Data</span><i class="bi bi-chevron-down ms-auto"></i>
            </a>
            <ul id="Data-nav" class="nav-content collapse" data-bs-parent="#sidebar-nav">
    
              <li>
                <a href="IncomingCallData.html">
                  <i class="bi bi-circle"></i><span>Incoming Call Data</span>
                </a>
              </li>
    
              <li>
                <a href="OutgoinfCallData.html">
                  <i class="bi bi-circle"></i><span>Outgoing Call Data</span>
                </a>
              </li>
              <!-- Add more items as needed -->
            </ul>
          </li>
    
        </ul>
      </aside>
    <!-- End Sidebar-->

    <main id="main" class="main">
        <div class="table-responsive">
            <div class="container">
                <h2 class="text-center mb-4">Daily Login Data</h2>
                <div class="table-container">
                    <div class="calendar-container">
                        <form>
                            <!-- <label for="dateInput">Choose a Date:</label> -->
                            <input type="date" id="dateInput" max="" name="dateInput" required>
                            <input type="submit" id="submitbtn" value="Submit">
                        </form>
                    </div>
                    <table class="table table-bordered" id="table">
                        <thead class="thead">
                            <tr>
                                <th>Agent</th>
                                <th>Waiting for Call</th>
                                <th>ON Call</th>
                                <th>Disposition Time</th>
                                <th>Break Time</th>
                                <th>Total Login Time</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- data will be added dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>



        <!-- Modal -->
        <div class="modal" id="myModal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <!-- Modal Body -->
                    <div class="modal-body">
                        <table class="table" id="modaltable">
                            <thead>
                                <tr>
                                    <th>Action Type</th>
                                    <th>Time</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>






    </main>
    <!-- End #main -->

    <!-- ======= Footer ======= -->
    <footer id="footer" class="footer">
        <div class="copyright">
            &copy; Copyright <strong><span>iotcom</span></strong>. All Rights Reserved
        </div>
        <div class="credits">
            Designed by <a href="https://www.iotcom.io/">Iotcom</a>
        </div>
    </footer>
    <!-- End Footer -->

    <a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i
            class="bi bi-arrow-up-short"></i></a>
    <!-- Date Range JS Files -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>

        const storedUsername = document.getElementById("displayUsername");
        const storedUsername1 = document.getElementById("displayUsername1");
        const storedorg = document.getElementById("displayorg");

        var dateselect = document.getElementById("dateInput");
        const submitButton=document.getElementById("submitbtn");
        var detaileddata = {};

        document.addEventListener("DOMContentLoaded", function () {
            ALH();
            const storedUsername = JSON.parse(localStorage.getItem('admininfo')).user;
            const storedorg = JSON.parse(localStorage.getItem('admininfo')).organization;

            if (storedUsername) {
                document.getElementById('displayUsername').innerText = storedUsername;
                document.getElementById('displayUsername1').innerText = storedUsername;
                document.getElementById('displayorg').innerText = storedorg;
            } else {
                document.getElementById('displayUsername').innerText = 'No stored username found.';
                document.getElementById('displayUsernam1').innerText = 'No stored username found.';
            }
        });

        submitButton.addEventListener("click", ALH);

        function ALH() {

            let dateobj;

            if (dateselect.value) {
                // If user selected a date, use the selected date
                dateobj = {
                    startdate: dateselect.value,
                    starttime: "00:00:00",
                    enddate: dateselect.value,
                    endtime: "23:59:59"
                };
            } else {
                // If user did not select a date, use the current date
                let currentDate = new Date();
                let year = currentDate.getFullYear();
                let month = String(currentDate.getMonth() + 1).padStart(2, '0'); // January is 0!
                let day = String(currentDate.getDate()).padStart(2, '0');
                let formattedDate = `${year}-${month}-${day}`;

                dateobj = {
                    startdate: formattedDate,
                    starttime: "00:00:00",
                    enddate: formattedDate,
                    endtime: "23:59:59"
                };
            }
            const url = "/agentlogindata";

            fetch(url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    'Authorization': `Bearer ${localStorage.getItem('jwtToken')}`
                },
                body: JSON.stringify(dateobj)
            })

                .then((Response) => {
                    if (Response.status === 401) {
                        // Unauthorized response handling: redirect to index page or handle as needed
                        window.location.href = '/login.html'; // Replace with your index page URL
                    } else {
                        return Response.json();
                    }
                })
                .then((s) => {
                    const rawData = s.result;

                    if(rawData.length>0){
                    const filterData = rawData.filter(a => a.Status !== "RINGING" && a.Status !== "RINGINUSE");
                    // Create an object to store separate arrays for each user
                    const userArrays = {};
                    


                    // Iterate through the data and organize it by user
                    filterData.forEach(item => {
                        const user = item.user;

                        if (!userArrays[user]) {
                            userArrays[user] = [];
                            detaileddata[user] = [];
                        }

                        userArrays[user].push(item);
                        detaileddata[user].push(item);

                    });

                    console.log(detaileddata);

                    for (const user in userArrays) {
                        if (userArrays.hasOwnProperty(user)) {
                            let mainarray = userArrays[user];
                            const newarray = [];

                            for (let a = 0; a < mainarray.length - 1; a++) {
                                const startingStatus = mainarray[a].Status;
                                const endStatus = mainarray[a + 1].Status;
                                const startTime = new Date(mainarray[a].Time).getTime();
                                const endTime = new Date(mainarray[a + 1].Time).getTime();
                                const duration = endTime - startTime;

                                const Data = {
                                    startingStatus,
                                    endStatus,
                                    duration,
                                    Action: action(startingStatus, endStatus),
                                };

                                newarray.push(Data);
                            }
                            userArrays[user] = newarray;
                        }
                    }
                    //console.log(userArrays);
                    const userSummaryArray = [];

                    for (const user in userArrays) {
                        if (userArrays.hasOwnProperty(user)) {
                            const userData = userArrays[user];

                            const summary = {
                                user,
                                waitingforcall: 0,
                                oncall: 0,
                                break: 0,
                                disposition: 0,
                                totallogintime: 0
                            };

                            userData.forEach(data => {
                                if (data.Action === "WaitingForCall") {
                                    summary.waitingforcall += data.duration;
                                } else if (data.Action === "OnCall") {
                                    summary.oncall += data.duration;
                                } else if (data.Action === "Disposition") {
                                    summary.disposition += data.duration;
                                } else if (data.Action === "Offline") {
                                    summary.offline += data.duration;
                                } else {
                                    summary.break += data.duration;
                                }

                                summary.totallogintime = summary.waitingforcall + summary.oncall + summary.disposition;
                            });

                            // Convert the total times to "h:m:s" format
                            summary.waitingforcall = msToHMS(summary.waitingforcall);
                            summary.oncall = msToHMS(summary.oncall);
                            summary.break = msToHMS(summary.break);
                            summary.disposition = msToHMS(summary.disposition);
                            summary.totallogintime = msToHMS(summary.totallogintime);

                            userSummaryArray.push(summary);
                        }
                    }

                    console.log(userSummaryArray);
                    populateagent(userSummaryArray);

                }else{
                    populateagent([]);
                }
                })

        }

        function populatedetailed(userData) {
                        console.log("populatedetailed");
                        const table = document.getElementById("modaltable").getElementsByTagName("tbody")[0];
                        table.innerHTML = "";

                        userData.forEach(function (call) {
                            let newRow = table.insertRow(table.rows.length);
                            let cell1 = newRow.insertCell(0);
                            let cell2 = newRow.insertCell(1);
                            let cell3 = newRow.insertCell(2);

                            // Assuming call object properties exist and match the cell positions
                            cell1.textContent = call.Type || '-';
                            cell2.textContent = formatDateTime(call.Time) || '-';
                            cell3.textContent = call.Status || '-';
                        });

                   
                    }



        function formatDateTime(dateTimeString) {
                            const istDate = new Date(dateTimeString);
                            const day = String(istDate.getDate()).padStart(2, '0');
                            const month = String(istDate.getMonth() + 1).padStart(2, '0');
                            const year = istDate.getFullYear();
                            const formattedDate = `${day}/${month}/${year}`;

                            const formattedTime = istDate.toLocaleString('en-US', {
                                timeZone: 'Asia/Kolkata',
                                hour: 'numeric',
                                minute: 'numeric',
                                second: 'numeric',
                                hour12: true
                            });

                            const istDateFormat = `${formattedDate}\n\n\n${formattedTime}`;
                            return istDateFormat;
                        }
        
        function populateagent(userSummaryArray) {
                        console.log("populateagent");
                        const table = document.getElementById("table").getElementsByTagName("tbody")[0];
                        table.innerHTML = "";
                     if(userSummaryArray.length>0){
                        userSummaryArray.forEach(function (call) {
                            let newRow = table.insertRow(table.rows.length);
                            let cell1 = newRow.insertCell(0);
                            let cell2 = newRow.insertCell(1);
                            let cell3 = newRow.insertCell(2);
                            let cell4 = newRow.insertCell(3);
                            let cell5 = newRow.insertCell(4);
                            let cell6 = newRow.insertCell(5);
                            let cell7 = newRow.insertCell(6);


                            // Assuming call object properties exist and match the cell positions
                            cell1.textContent = call.user;
                            cell2.textContent = call.waitingforcall;
                            cell3.textContent = call.oncall;
                            cell4.textContent = call.disposition;
                            cell5.textContent = call.break;
                            cell6.textContent = call.totallogintime;


                            // Create a button element and set its class and innerHTML
                            let actionButton = document.createElement("button");
                            actionButton.className = "btn btn-success";
                            actionButton.innerHTML = '<i class="bi bi-clipboard2-data-fill"></i>';
                            actionButton.setAttribute('data-bs-toggle', 'modal');
                            actionButton.setAttribute('data-bs-target', '#myModal');

                            // Append the button to the 8th cell
                            cell7.appendChild(actionButton);
                            actionButton.addEventListener("click", function () {
                                populatedetailed(detaileddata[call.user]);
                            });

                        });
                    }
                    }





        function action(a, b) {
                        let Action;
                        if (a === "UNAVAILABLE") {
                            Action = "Offline";
                        } else if (a === "Disposition") {
                            Action = "Disposition";
                        } else if (a === "NOT_INUSE") {
                            Action = "WaitingForCall";
                        } else if (a === "INUSE") {
                            Action = "OnCall";
                        } else {
                            Action = "Invalid";
                        }
                        return Action;
                    }

            // Function to convert milliseconds to "h:m:s" format
            function msToHMS(duration) {
                        const seconds = Math.floor((duration / 1000) % 60);
                        const minutes = Math.floor((duration / (1000 * 60)) % 60);
                        const hours = Math.floor((duration / (1000 * 60 * 60)) % 24);
                        return `${hours}h ${minutes}m ${seconds}s`;
                    }
        function signOut() {
            // Clear localStorage (optional)
            localStorage.removeItem('admininfo');
            localStorage.removeItem('jwtToken');
            localStorage.removeItem('didData');

            // Redirect to the desired location
            window.location.href = '/login.html';
        }
    </script>

    <!-- Vendor JS Files -->
    <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="assets/vendor/tinymce/tinymce.min.js"></script>

    <!-- Template Main JS File -->
    <script src="assets/js/main.js"></script>
</body>

</html>