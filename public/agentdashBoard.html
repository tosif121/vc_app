<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />

    <title>Agent Dashboard</title>
    <meta content="" name="description" />
    <meta content="" name="keywords" />

    <!-- Favicons -->
    <link href="./img/favicon.png" rel="icon" />

    <!-- Google Fonts -->
    <link href="https://fonts.gstatic.com" rel="preconnect" />
    <link
      href="https://fonts.googleapis.com/css?family=https://fonts.googleapis.com/css?family=Poppins:300,300i,400,400i,500,500i,600,600i,700,700i"
      rel="stylesheet"
    />

    <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Template Main CSS File -->
    <link href="assets/css/style.css" rel="stylesheet" />
  </head>

  <body>
    <section class="flex min-h-screen flex-col">
      <header id="header" class="header sticky top-0 flex items-center justify-between">
        <div class="flex justify-between w-full items-center">
          <a href="agentdashBoard.html">
            <img src="./img/logo.png" alt="iotcom" class="w-56" />
          </a>

          <ul id="sidebar-nav" class="flex gap-10 me-10">
            <li class="">
              <a class="active" href="agentdashBoard.html"> Dashboard </a>
            </li>
            <li class="">
              <a class="" href="agentIncomingDrop.html"> Drop Calls </a>
            </li>
            <li class="">
              <a class="" href="agentcallData.html"> My Calls </a>
            </li>
            <!-- End Dashboard Nav -->
          </ul>
        </div>

        <div class="relative inline-block">
          <button class="py-2 px-4 rounded inline-flex items-center focus:outline-none" id="dropdown-btn">
            <img src="img/shiv.jpg" alt="Profile" class="rounded-full w-10 h-10" />
            <span class="d-none d-md-block dropdown-toggle ps-2" id="displayUsername"></span>
            <svg class="fill-current ml-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
              <path
                d="M10 12.586L4.293 6.879a1 1 0 0 0-1.414 1.414l6.364 6.364a1 1 0 0 0 1.414 0l6.364-6.364a1 1 0 0 0-1.414-1.414L10 12.586z"
              />
            </svg>
          </button>
          <div
            class="absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 transition-all duration-200 opacity-0 invisible"
            id="dropdown-menu"
          >
            <ul class="py-1 px-3" role="menu" aria-orientation="vertical" aria-labelledby="options-menu">
              <li class="py-3 border-b">
                <h6 id="displayUsername1">Shiv Shekhawat</h6>
                <span id="displayorg">Web Designer</span>
              </li>
              <li class="py-3 border-b">
                <i class="bi bi-person"></i>
                <span>My Profile</span>
              </li>
              <li class="py-3 border-b"><i class="bi bi-gear"></i> <span>Account Settings</span></li>
              <li class="py-3 border-b"><i class="bi bi-question-circle"></i> <span>Need Help?</span></li>
              <li class="py-3">
                <a class="dropdown-item d-flex align-items-center" href="#" onclick="signOut()">
                  <i class="bi bi-box-arrow-right"></i>
                  <span>Sign Out</span>
                </a>
              </li>
            </ul>
          </div>
        </div>
      </header>

      <main id="main" class="main grow m-8">
        <audio id="remoteaudio" autoplay style="display: none"></audio>
        <div class="flex align-items-center gap-10 mb-4">
          <div class="bg-white shadow-sm w-full p-4 rounded-sm">
            <div class="flex items-center justify-between">
              <div class="">
                <p class="font-bold text-2xl" id="totalCalls">10</p>
                <h5 class="text-xl font-semibold">Total Calls</h5>
              </div>
              <div class="">
                <i class="text-3xl text-[#2196f3] bi bi-people-fill"></i>
              </div>
            </div>
          </div>
          <div class="bg-white shadow-sm w-full p-4 rounded-sm">
            <div class="flex items-center justify-between">
              <div class="">
                <p class="font-bold text-2xl" id="dropCalls">0</p>
                <h5 class="text-xl font-semibold">Total Drop Calls</h5>
              </div>
              <div class="">
                <i class="text-3xl text-[#2196f3] bi bi-person-check-fill"></i>
              </div>
            </div>
          </div>
          <div class="bg-white shadow-sm w-full p-4 rounded-sm">
            <div class="flex items-center justify-between">
              <div class="">
                <p class="font-bold text-2xl" id="myCalls">0</p>
                <h5 class="text-xl font-semibold">My Calls</h5>
              </div>
              <div class="">
                <i class="text-3xl text-[#2196f3] bi bi-telephone-inbound-fill"></i>
              </div>
            </div>
          </div>
          <div class="bg-white shadow-sm w-full p-4 rounded-sm">
            <div class="flex items-center justify-between">
              <div class="">
                <p class="font-bold text-2xl" id="avgdur">0</p>
                <h5 class="text-xl font-semibold">Average Duration</h5>
              </div>
              <div class="">
                <i class="text-3xl text-[#2196f3] bi bi-bell-fill"></i>
              </div>
            </div>
          </div>
        </div>

        <div class="flex flex-col mb-4">
          <div class="overflow-x-auto sm:-mx-6 lg:-mx-8">
            <div class="inline-block min-w-full py-2 sm:px-6 lg:px-8">
              <div class="overflow-hidden">
                <table class="min-w-full text-left text-sm font-light text-surface dark:text-white">
                  <thead class="border-b border-neutral-200 font-medium dark:border-white/10">
                    <tr>
                      <th scope="col" class="px-6 py-4">WaitingForCall</th>
                      <th scope="col" class="px-6 py-4">OnCall</th>
                      <th scope="col" class="px-6 py-4">Break</th>
                      <th scope="col" class="px-6 py-4">Disposition</th>
                      <th scope="col" class="px-6 py-4">Total login Time</th>
                      <th scope="col" class="px-6 py-4">Activity</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr class="border-b border-neutral-200 dark:border-white/10">
                      <td class="whitespace-nowrap px-6 py-4" id="waitingforcall"></td>
                      <td class="whitespace-nowrap px-6 py-4" id="oncall"></td>
                      <td class="whitespace-nowrap px-6 py-4" id="break"></td>
                      <td class="whitespace-nowrap px-6 py-4" id="disposition"></td>
                      <td class="whitespace-nowrap px-6 py-4" id="totallogintime"></td>
                      <td class="whitespace-nowrap px-6 py-4"><button id="activity">Activity</button></td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Modal -->
        <div class="modal" id="myModal">
          <div class="modal-dialog">
            <div class="modal-content">
              <!-- Modal Body -->
              <div class="modal-body">
                <table
                  class="min-w-full text-left text-sm font-light text-surface dark:text-white mb-4"
                  id="modaltable"
                >
                  <thead class="border-b border-neutral-200 font-medium dark:border-white/10">
                    <tr>
                      <th scope="col" class="px-6 py-4">WaitingForCall</th>
                      <th scope="col" class="px-6 py-4">Action Type</th>
                      <th scope="col" class="px-6 py-4">Time</th>
                      <th scope="col" class="px-6 py-4">Status</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <div class="flex h-screen gap-5 mb-4">
          <div class="bg-white shadow-sm p-3 rounded-sm w-1/2 h-full">
            <canvas class="w-full h-full" id="mychart"></canvas>
          </div>

          <div class="bg-white shadow-sm p-3 rounded-sm w-1/2 h-full">
            <canvas class="w-full h-full" id="earning"></canvas>
          </div>
        </div>
      </main>
      <!-- End #main -->

      <!-- ======= Footer ======= -->
      <footer id="footer" class="footer">
        <div class="copyright">
          &copy; Copyright <strong><span>iotcom</span></strong
          >. All Rights Reserved
        </div>
        <div class="credits">Designed by <a href="https://www.iotcom.io/">Iotcom</a></div>
      </footer>
      <!-- End Footer -->
    </section>
    <a href="#" class="back-to-top flex items-center justify-center"><i class="bi bi-arrow-up-short"></i></a>

    <script src="jssip-3.10.0.min.js"></script>
    <script>
      var mainurl = `https://devapp.iotcom.io`;
      let callData = [];
      let activityData = [];
      var user = JSON.parse(localStorage.getItem('userinfo')).userid;
      document.addEventListener('DOMContentLoaded', makeDashboard);
      document.getElementById('activity').className =
        'inline-block rounded text-white bg-green-700 hover:bg-transparent hover:border-green-700 border transition-all	 hover:text-green-700 text-lg px-2';
      document.getElementById('activity').innerHTML = '<i class="bi bi-clipboard2-data-fill"></i>';
      document.getElementById('activity').setAttribute('data-bs-toggle', 'modal');
      document.getElementById('activity').setAttribute('data-bs-target', '#myModal');
      document.getElementById('activity').addEventListener('click', function () {
        populatedetailed(activityData);
      });

      async function makeDashboard() {
        await fetch(`${mainurl}/agentDashboardData`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${localStorage.getItem('jwtToken')}`,
          },
          body: JSON.stringify({ user: `${JSON.parse(localStorage.getItem('userinfo')).userid}` }),
        })
          .then((Response) => {
            if (Response.status === 401) {
              // Unauthorized response handling: redirect to index page or handle as needed
              window.location.href = '/agentLogin.html'; // Replace with your index page URL
            } else {
              return Response.json();
            }
          })
          .then((s) => {
            const rawData = s.DataArray;
            callData = s.todayCalls;
            console.log(callData);
            if (rawData.length > 0) {
              const filterData = rawData.filter((a) => a.Status !== 'RINGING' && a.Status !== 'RINGINUSE');
              console.log(filterData);
              activityData = filterData;
              const newarray = [];

              for (let a = 0; a < filterData.length - 1; a++) {
                const startingStatus = filterData[a].Status;
                const endStatus = filterData[a + 1].Status;
                const startTime = new Date(filterData[a].Time).getTime();
                const endTime = new Date(filterData[a + 1].Time).getTime();
                const duration = endTime - startTime;

                const Data = {
                  startingStatus,
                  endStatus,
                  duration,
                  Action: action(startingStatus, endStatus),
                };

                newarray.push(Data);
              }
              const summary = {
                user,
                waitingforcall: 0,
                oncall: 0,
                break: 0,
                disposition: 0,
                totallogintime: 0,
              };

              newarray.forEach((data) => {
                if (data.Action === 'WaitingForCall') {
                  summary.waitingforcall += data.duration;
                } else if (data.Action === 'OnCall') {
                  summary.oncall += data.duration;
                } else if (data.Action === 'Disposition') {
                  summary.disposition += data.duration;
                } else if (data.Action === 'Offline') {
                  summary.offline += data.duration;
                } else {
                  summary.break += data.duration;
                }

                summary.totallogintime = summary.waitingforcall + summary.oncall + summary.disposition;
              });
              const chartData = [summary.waitingforcall, summary.oncall, summary.break, summary.disposition];

              // Convert the total times to "h:m:s" format
              summary.waitingforcall = msToHMS(summary.waitingforcall);
              summary.oncall = msToHMS(summary.oncall);
              summary.break = msToHMS(summary.break);
              summary.disposition = msToHMS(summary.disposition);
              summary.totallogintime = msToHMS(summary.totallogintime);

              changeData(callData, summary, chartData);
            }
          })

          .catch((err) => {
            console.log(err);
          });
      }

      function changeData(callData, summary, chartData) {
        let TotalDuration = 0;
        const totalcalls = callData.length;
        const AgentCalls = callData.filter((A) => A.agent == user);
        const AgentcallsNo = AgentCalls.length;
        const missedCalls = callData.filter((A) => A.Type == 'incoming' && A.anstime == undefined);
        let avgTimeperCall;
        if (AgentCalls.length > 0) {
          //take only incoming Calls
          const incomingAnswerdCalls = AgentCalls.filter((k) => k.Type == 'incoming');
          console.log(incomingAnswerdCalls);
          for (let i = 0; i < incomingAnswerdCalls.length; i++) {
            const currentDuration = incomingAnswerdCalls[i].hanguptime - incomingAnswerdCalls[i].anstime;
            TotalDuration = TotalDuration + currentDuration;
          }
          avgTimeperCall = TotalDuration > 0 ? TotalDuration / (1000 * incomingAnswerdCalls.length) : 0;
        }
        document.getElementById('totalCalls').innerText = totalcalls;
        document.getElementById('myCalls').innerText = AgentCalls.length;
        document.getElementById('dropCalls').innerText = missedCalls.length;
        document.getElementById('avgdur').innerText = `${avgTimeperCall} sec`;
        document.getElementById('waitingforcall').innerText = summary.waitingforcall;
        document.getElementById('oncall').innerText = summary.oncall;
        document.getElementById('break').innerText = summary.break;
        document.getElementById('disposition').innerText = summary.disposition;
        document.getElementById('totallogintime').innerText = summary.totallogintime;
        modifyChart(chartData);
        modifyChart2(AgentCalls);
      }

      // for every details
      function populatedetailed(userData) {
        console.log('populatedetailed');
        console.log(userData);
        const table = document.getElementById('modaltable').getElementsByTagName('tbody')[0];
        table.innerHTML = '';

        userData.forEach(function (call) {
          let newRow = table.insertRow(table.rows.length);
          let cell1 = newRow.insertCell(0);
          let cell2 = newRow.insertCell(1);
          let cell3 = newRow.insertCell(2);

          // Assuming call object properties exist and match the cell positions
          cell1.textContent = call.Type || '-';
          cell2.textContent = formatDateTime(call.Time) || '-';
          cell3.textContent = call.Status || '-';
        });
      }

      function formatDateTime(dateTimeString) {
        const istDate = new Date(dateTimeString);
        const day = String(istDate.getDate()).padStart(2, '0');
        const month = String(istDate.getMonth() + 1).padStart(2, '0');
        const year = istDate.getFullYear();
        const formattedDate = `${day}/${month}/${year}`;

        const formattedTime = istDate.toLocaleString('en-US', {
          timeZone: 'Asia/Kolkata',
          hour: 'numeric',
          minute: 'numeric',
          second: 'numeric',
          hour12: true,
        });

        const istDateFormat = `${formattedDate}\n\n\n${formattedTime}`;
        return istDateFormat;
      }
      // Function to convert milliseconds to "h:m:s" format
      function msToHMS(duration) {
        const seconds = Math.floor((duration / 1000) % 60);
        const minutes = Math.floor((duration / (1000 * 60)) % 60);
        const hours = Math.floor((duration / (1000 * 60 * 60)) % 24);
        return `${hours}h ${minutes}m ${seconds}s`;
      }
      function action(a, b) {
        let Action;
        if (a === 'UNAVAILABLE') {
          Action = 'Offline';
        } else if (a === 'Disposition') {
          Action = 'Disposition';
        } else if (a === 'NOT_INUSE') {
          Action = 'WaitingForCall';
        } else if (a === 'INUSE') {
          Action = 'OnCall';
        } else {
          Action = 'Invalid';
        }
        return Action;
      }

      //chart functions
      function modifyChart(array1) {
        var ctx = document.getElementById('mychart').getContext('2d');
        var earning = document.getElementById('earning').getContext('2d');
        var myChart = new Chart(ctx, {
          type: 'polarArea',
          data: {
            labels: ['Waiting For Call', 'On Call', 'Break', 'Disposition'],
            datasets: [
              {
                labels: '# of Counts',
                data: array1,
                backgroundColor: [
                  'rgba(255, 99, 132)',
                  'rgba(54, 162, 235)',
                  'rgba(255, 206, 86)',
                  'rgba(75, 192, 192)',
                ],
              },
            ],
          },
          options: {
            responsive: true,
          },
        });
      }

      function modifyChart2(Data) {
        const DispositionArray = Data.map((x) => (x.Disposition != undefined ? x.Disposition : 'NO Disposition'));

        // Get labels and data from the array
        const { labels, data } = processArray(DispositionArray);

        var myChart = new Chart(earning, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [
              {
                data: data,
                backgroundColor: [
                  'RGB(255, 0, 0)',
                  'RGB(255, 128, 0)',
                  'RGB(255, 255, 0)',
                  'RGB(128, 255, 0)',
                  'RGB(0, 255, 0)',
                  'RGB(0, 255, 128)',
                  'RGB(0, 0, 255)',
                  'RGB(128, 0, 255)',
                  'RGB(255, 0, 255)',
                  'RGB(255, 0, 128)',
                  'RGB(0, 128, 255)',
                  'RGB(0, 255, 255)',
                ],
                borderWidth: 1,
              },
            ],
          },
          options: {
            scales: {
              y: {
                responsive: true,
              },
            },
          },
        });
      }

      // Function to process the array and generate labels and data
      function processArray(inputArray) {
        const labelsMap = new Map();

        inputArray.forEach((item) => {
          if (labelsMap.has(item)) {
            labelsMap.set(item, labelsMap.get(item) + 1);
          } else {
            labelsMap.set(item, 1);
          }
        });

        const labels = Array.from(labelsMap.keys());
        const data = Array.from(labelsMap.values());

        return { labels, data };
      }
      // function logout
      function signOut() {
        // Clear localStorage (optional)
        localStorage.removeItem('userinfo');
        localStorage.removeItem('jwtToken');
        //localStorage.removeItem('didData');

        // Redirect to the desired location
        window.location.href = '/login.html';
      }

      const dropdownBtn = document.getElementById('dropdown-btn');
      const dropdownMenu = document.getElementById('dropdown-menu');

      dropdownBtn.addEventListener('click', () => {
        dropdownMenu.classList.toggle('opacity-0');
        dropdownMenu.classList.toggle('invisible');
      });

      // Close the dropdown menu when clicking outside
      document.addEventListener('click', (event) => {
        if (!dropdownBtn.contains(event.target) && !dropdownMenu.contains(event.target)) {
          dropdownMenu.classList.add('opacity-0', 'invisible');
        }
      });
    </script>
    <!-- Vendor JS Files -->
    <script src="assets/vendor/tinymce/tinymce.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Template Main JS File -->
    <script src="assets/js/main.js"></script>
  </body>
</html>
