<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />

    <title>Call Records</title>
    <meta content="" name="description" />
    <meta content="" name="keywords" />

    <!-- Favicons -->
    <link href="./img/favicon.png" rel="icon" />
    <!-- Google Fonts -->
    <link href="https://fonts.gstatic.com" rel="preconnect" />
    <link
      href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i"
      rel="stylesheet"
    />

    <!-- Vendor CSS Files -->
    <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
    <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet" />

    <!-- pagination JQuery -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css" />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.datatables.net/buttons/2.1.1/css/buttons.dataTables.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.70/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.70/vfs_fonts.js"></script>

    <!-- Template Main CSS File -->
    <link href="assets/css/style.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
    <style>
      .seek_slider,
      .volume_slider {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        height: 5px;
        background: #83a9ff;
        -webkit-transition: 0.2s;
        transition: opacity 0.2s;
      }

      .seek_slider::-webkit-slider-thumb,
      .volume_slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        width: 15px;
        height: 15px;
        background: white;
        border: 3px solid #3774ff;
        cursor: grab;
        border-radius: 100%;
      }

      .seek_slider:hover,
      .volume_slider:hover {
        opacity: 1;
      }

      .seek_slider {
        width: 60%;
      }

      .volume_slider {
        width: 30%;
      }

      .current-time,
      .total-duration {
        padding: 10px;
      }

      .bridge-container {
        text-align: center;
      }

      .bridge-container a {
        text-decoration: none;
        color: black;
      }

      .buttons {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 20px;
      }

      .buttons i {
        font-size: 36px;
        color: #333333;
      }

      .playpause-track i {
        color: #2ecc71;
      }

      .repeat-track,
      .random-track,
      .playpause-track,
      .prev-track,
      .next-track {
        padding: 25px;
        opacity: 0.8;
        transition: opacity 0.2s;
      }

      .repeat-track:hover,
      .random-track:hover,
      .playpause-track:hover,
      .prev-track:hover,
      .next-track:hover {
        opacity: 1;
      }

      .loader {
        height: 70px;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .loader .stroke {
        background: linear-gradient(to right, #9a1d86, #1595be);
        height: 150%;
        width: 10px;
        border-radius: 50px;
        margin: 0 5px;
        animation: animate 1.4s linear infinite;
      }

      @keyframes animate {
        50% {
          height: 30%;
          background: #cf77c1;
        }

        100% {
          background: #53b9db;
          height: 100%;
        }
      }

      .stroke:nth-child(1) {
        animation-delay: 0s;
      }

      .stroke:nth-child(2) {
        animation-delay: 0.8s;
      }

      .stroke:nth-child(3) {
        animation-delay: 0.6s;
      }

      .stroke:nth-child(4) {
        animation-delay: 0.5s;
      }

      .stroke:nth-child(5) {
        animation-delay: 0.4s;
      }

      .stroke:nth-child(6) {
        animation-delay: 0.2s;
      }

      .stroke:nth-child(7) {
        animation-delay: 0s;
      }
    </style>
  </head>

  <body>
    <section class="d-flex min-vh-100 flex-column">
      <header id="header" class="header sticky-top d-flex align-items-center">
        <div class="d-flex align-items-center justify-content-center">
          <a href="admindashboard.html" class="logo d-flex align-items-center">
            <img src="./img/logo.png" alt="iotcom" />
          </a>
        </div>
        <div class="ms-auto d-flex align-items-end">
          <div id="sidebar" class="sidebar me-5">
            <ul class="sidebar-nav d-flex gap-4" id="sidebar-nav">
              <li class="nav-item">
                <a class="nav-link" href="admindashboard.html">
                  <!-- <i class="bi bi-grid"></i> -->
                  <span>Dashboard</span>
                </a>
              </li>
              <!-- End Dashboard Nav -->

              <li class="nav-item">
                <a class="nav-link collapsed" data-bs-target="#icons-nav" data-bs-toggle="collapse" href="#">
                  <!-- <i class="bi bi-gem"></i> -->
                  <span>Users</span><i class="bi bi-chevron-down ms-2"></i>
                </a>
                <ul id="icons-nav" class="nav-content collapse" data-bs-parent="#sidebar-nav">
                  <li>
                    <a href="adduser.html"> <i class="bi bi-chevron-right"></i><span>Add New Users</span> </a>
                  </li>
                  <li>
                    <a href="userlist.html"> <i class="bi bi-chevron-right"></i><span>User List</span> </a>
                  </li>
                  <li>
                    <a href="AgentLoginHours.html">
                      <i class="bi bi-chevron-right"></i><span>Agent Login Hours</span>
                    </a>
                  </li>

                  <li>
                    <a href="Forcelogout.html"> <i class="bi bi-chevron-right"></i><span>Force Logout</span> </a>
                  </li>
                </ul>
              </li>

              <!-- Broadcast Section -->
              <li class="nav-item">
                <a class="nav-link collapsed" data-bs-target="#Broadcast-nav" data-bs-toggle="collapse" href="#">
                  <!-- <i class="bi bi-broadcast"></i> -->
                  <span>Broadcast</span><i class="bi bi-chevron-down ms-2"></i>
                </a>
                <ul id="Broadcast-nav" class="nav-content collapse" data-bs-parent="#sidebar-nav">
                  <li>
                    <a href="broadcast.html"> <i class="bi bi-chevron-right"></i><span>Add Broadcast</span> </a>
                  </li>
                  <li>
                    <a href="Broadcastform.html"> <i class="bi bi-chevron-right"></i><span>Upload Broadcast</span> </a>
                  </li>
                  <li>
                    <a href="broadCastReport.html">
                      <i class="bi bi-chevron-right"></i><span>Broadcast Report</span>
                    </a>
                  </li>
                  <li>
                    <a href="broadCastSummary.html">
                      <i class="bi bi-chevron-right"></i><span>Broadcast Summary</span>
                    </a>
                  </li>
                  <!-- Add more items as needed -->
                </ul>
              </li>

              <!-- campagian Section -->
              <li class="nav-item">
                <a class="nav-link collapsed" data-bs-target="#Campaign-nav" data-bs-toggle="collapse" href="#">
                  <!-- <i class="bi bi-layout-text-window-reverse"></i> -->
                  <span>Campaign</span><i class="bi bi-chevron-down ms-2"></i>
                </a>
                <ul id="Campaign-nav" class="nav-content collapse" data-bs-parent="#sidebar-nav">
                  <li>
                    <a href="newcampaign.html"> <i class="bi bi-chevron-right"></i><span>Add Campaign</span> </a>
                  </li>

                  <li>
                    <a href="form.html"> <i class="bi bi-chevron-right"></i><span>Upload Campaign</span> </a>
                  </li>
                  <!-- Add more items as needed -->
                  <li>
                    <a href="offlineCampaign.html"> <i class="bi bi-chevron-right"></i><span>Offline Campaign</span> </a>
                  </li>
                </ul>
              </li>
              <!-- End Blank Page Nav -->

              <li class="nav-item">
                <a class="nav-link collapsed" href="CallMenu.html">
                  <!-- <i class="bi bi-telephone-plus"></i> -->
                  <span>Call Menu</span>
                </a>
              </li>
              <!-- End Blank Page Nav -->

              <li class="nav-item">
                <a class="nav-link collapsed" href="AudioStore.html">
                  <!-- <i class="bi bi-file-earmark-music"></i> -->
                  <span>Audio Store</span>
                </a>
              </li>

              <li class="nav-item">
                <a class="nav-link collapsed" href="DID.html">
                  <!-- <i class="bi bi-card-list"></i> -->
                  <span>Add/Show DID</span>
                </a>
              </li>

              <li class="nav-item">
                <a class="nav-link collapsed" data-bs-target="#Data-nav" data-bs-toggle="collapse" href="#">
                  <span>Call Reports</span> <i class="bi bi-chevron-down ms-2"></i>
                </a>
                <ul id="Data-nav" class="nav-content collapse" data-bs-parent="#sidebar-nav">
                  <li>
                    <a href="aprReport.html">
                      <i class="bi bi-chevron-right"></i><span>Agent performance report</span>
                    </a>
                  </li>
                  <li>
                    <a href="calldata.html">
                      <i class="bi bi-chevron-right"></i><span>Call detail report</span>
                    </a>
                  </li>
                  <li>
                    <a href="IncomingCallData.html">
                      <i class="bi bi-chevron-right"></i><span>Incoming Call reports</span>
                    </a>
                  </li>

                  <li>
                    <a href="OutgoinfCallData.html">
                      <i class="bi bi-chevron-right"></i><span>Outgoing Call reports</span>
                    </a>
                  </li>
                  <li>
                    <a href="incomingDrop.html"> <i class="bi bi-chevron-right"></i><span>Drop Call reports</span> </a>
                  </li>
                  <!-- Add more items as needed -->
                </ul>
              </li>
            </ul>
          </div>

          <!-- End Logo -->

          <div class="search-bar" style="display: none">
            <form class="search-form d-flex align-items-center" method="POST" action="#">
              <input type="text" name="query" placeholder="Search" title="Enter search keyword" />
              <button type="submit" title="Search">
                <i class="bi bi-search"></i>
              </button>
            </form>
          </div>
          <!-- End Search Bar -->

          <nav class="header-nav ms-auto">
            <ul class="d-flex align-items-center">
              <li class="nav-item d-block d-lg-none">
                <a class="nav-link nav-icon search-bar-toggle" href="#" style="display: none">
                  <i class="bi bi-search"></i>
                </a>
              </li>
              <!-- End Search Icon-->

              <li class="nav-item dropdown pe-3">
                <a class="nav-link nav-profile d-flex align-items-center pe-0" href="#" data-bs-toggle="dropdown">
                  <img src="img/shiv.jpg" alt="Profile" class="rounded-circle" />
                  <span class="d-none d-md-block dropdown-toggle ps-2 text-capitalize" id="displayUsername"></span> </a
                ><!-- End Profile Iamge Icon -->

                <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow profile">
                  <li class="dropdown-header text-capitalize">
                    <h6 id="displayUsername1">Shiv Shekhawat</h6>
                    <span id="displayorg">Web Designer</span>
                  </li>
                  <li>
                    <hr class="dropdown-divider" />
                  </li>

                  <li>
                    <a class="dropdown-item d-flex align-items-center" href="users-profile.html">
                      <i class="bi bi-person"></i>
                      <span>My Profile</span>
                    </a>
                  </li>
                  <li>
                    <hr class="dropdown-divider" />
                  </li>

                  <li>
                    <a class="dropdown-item d-flex align-items-center" href="users-profile.html">
                      <i class="bi bi-gear"></i>
                      <span>Account Settings</span>
                    </a>
                  </li>
                  <li>
                    <hr class="dropdown-divider" />
                  </li>

                  <li>
                    <a class="dropdown-item d-flex align-items-center" href="pages-faq.html">
                      <i class="bi bi-question-circle"></i>
                      <span>Need Help?</span>
                    </a>
                  </li>
                  <li>
                    <hr class="dropdown-divider" />
                  </li>

                  <li>
                    <a class="dropdown-item d-flex align-items-center" href="#" onclick="signOut()">
                      <i class="bi bi-box-arrow-right"></i>
                      <span>Sign Out</span>
                    </a>
                  </li>
                </ul>
                <!-- End Profile Dropdown Items -->
              </li>
              <!-- End Profile Nav -->
            </ul>
          </nav>
        </div>
        <!-- End Icons Navigation -->
      </header>
      <!-- End Sidebar-->

      <main id="main" class="main flex-grow-1">
        <div class="container-fluid">
          <div class="bg-white shadow-sm rounded p-3 m-2">
            <div class="d-flex justify-content-between">
              <h3 class="text-center">Call Drop Data</h3>
              <input
                type="text"
                class="form-control w-25 mb-3"
                id="date-range-picker"
                placeholder="Select Date Range"
              />
            </div>
            <div class="table-responsive">
              <table class="table border table_incoming" id="calldata">
                <thead class="thead">
                  <tr>
                    <th>Caller</th>
                    <!-- <th>Dial No</th> -->
                    <!-- <th>Campaign</th> -->
                    <th>Call received on</th>
                    <!-- <th>Call answered</th> -->
                    <th>Call Disconnected</th>
                    <th>Duration</th>
                    <!-- <th>Agent</th> -->
                    <!-- <th>Disposition</th> -->
                    <!-- <th>Listen</th> -->
                  </tr>
                </thead>
                <tbody>
                  <!-- call records will be added dynamically -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </main>
      <!-- End #main -->

      <!-- ======= Footer ======= -->
      <footer id="footer" class="footer">
        <div class="copyright">
          &copy; Copyright <strong><span>iotcom</span></strong
          >. All Rights Reserved
        </div>
        <div class="credits">Designed by <a href="https://www.iotcom.io/">Iotcom</a></div>
      </footer>
    </section>
    <!-- End Footer -->

    <a href="#" class="back-to-top d-flex align-items-center justify-content-center"
      ><i class="bi bi-arrow-up-short"></i
    ></a>

    <!-- Date Range JS Files -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <!-- Include jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Include DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css" />

    <!-- Include DataTables JavaScript -->
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.1.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.1.1/js/buttons.html5.min.js"></script>

    <script>
      var campaignlist;
      let callDetails = []; // Declare userDetails outside the fetch function
      let filteredData = [];
      var aajDate = new Date();
      var dayBefore = new Date(Date.now() - 24 * 3600 * 1000);
      var DateObj = {
        startdate: aajDate,
        enddate: dayBefore,
      };
      let StartDate;
      let EndDate;

      const storedUsername = JSON.parse(localStorage.getItem('admininfo')).user;
      const storedorg = JSON.parse(localStorage.getItem('admininfo')).organization;

      if (storedUsername) {
        document.getElementById('displayUsername').innerText = storedUsername;
        document.getElementById('displayUsername1').innerText = storedUsername;
        document.getElementById('displayorg').innerText = storedorg;
      } else {
        document.getElementById('displayUsername').innerText = 'No stored username found.';
        document.getElementById('displayUsernam1').innerText = 'No stored username found.';
      }

      document.addEventListener('DOMContentLoaded', async function () {
        //console.log("page startted");
        loadcallData();
      });

       // Initialize Flatpickr for date range selection
       flatpickr("#date-range-picker", {
        mode: "range",
        dateFormat: "Y-m-d",
        onChange: function (selectedDates, dateStr, instance) {
          let StartDate;
          let EndDate;
          console.log(selectedDates);
          if (selectedDates.length > 1) {
            DateObj = {
              startdate: dateStr.split(" ")[0],
              enddate: dateStr.split(" ")[2]
                ? dateStr.split(" ")[2]
                : dateStr.split(" ")[0],
            };
            loadcallData(DateObj);
          } else if (selectedDates.length === 1) {
            DateObj = {
              startdate: dateStr,
              enddate: dateStr,
            };
            loadcallData(DateObj);
          } else {
            console.log(StartDate, EndDate);
            console.log("select date properly");
          }
        },
      });

      async function loadcallData(DatePicks) {
        console.log(DatePicks);
        let formattedDates;
        if (DatePicks != null && DatePicks != undefined) {
          formattedDates = {
            startdate: DatePicks.startdate,
            enddate: DatePicks.enddate,
          };
        } else {
          const currentdate = Date.now();
          const pastdate = currentdate - 86400000;
          formattedDates = {
            startdate: new Date(pastdate).toISOString().substring(0, 10),
            enddate: new Date(currentdate).toISOString().substring(0, 10),
          };
        }
        console.log(formattedDates);
        fetch('/callData', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${localStorage.getItem('jwtToken')}`,
          },
          body: JSON.stringify(formattedDates),
        })
          .then((response) => {
            if (response.status === 401) {
              // Unauthorized response handling: redirect to index page or handle as needed
              window.location.href = '/login.html'; // Replace with your index page URL
            } else if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            return response.json();
          })
          .then((data) => {
            callDetails = data.result;
            console.log(callDetails);

            if (callDetails !== null) {
              callDetails = callDetails.filter((x) => x.Type == 'incoming' && x.anstime == undefined);
              callDetails.sort((a, b) => {
                return b.startTime - a.startTime;
              });
              filteredData = []; // reset filterdata array
              callDetails.forEach((entry) => {
                entry.duration = Math.floor((entry.hanguptime - entry.startTime) / 1000); // assuming both times are in milliseconds
                entry.hanguptime = formatDateTime(entry.hanguptime);
                entry.startTime = formatDateTime(entry.startTime);
                filteredData.push(entry);

                function formatDateTime(dateTimeString) {
                  if (dateTimeString) {
                    const istDate = new Date(dateTimeString);
                    const day = String(istDate.getDate()).padStart(2, '0');
                    const month = String(istDate.getMonth() + 1).padStart(2, '0');
                    const year = istDate.getFullYear();
                    const formattedDate = `${day}/${month}/${year}`;

                    const formattedTime = istDate.toLocaleString('en-US', {
                      timeZone: 'Asia/Kolkata',
                      hour: 'numeric',
                      minute: 'numeric',
                      second: 'numeric',
                      hour12: true,
                    });

                    const istDateFormat = `${formattedDate}\n\n\n${formattedTime}`;
                    return istDateFormat;
                  } else {
                    return 'NA';
                  }
                }
              });

              populatecalls(filteredData);
            }
          })
          .catch((error) => {
            console.error('Error fetching call details:', error);
          });
      }

      function populatecalls(filteredData) {
        const Dttable = $('#calldata').DataTable();
        Dttable.destroy();
        console.log('populate calls');
        const table = document.getElementById('calldata').getElementsByTagName('tbody')[0];
        table.innerHTML = '';

        filteredData.forEach(function (call, index) {
          // Change 'file' to 'call'
          let newRow = table.insertRow(table.rows.length);
          // let cell1 = newRow.insertCell(0);
          // let cell2 = newRow.insertCell(1);
          // let cell3 = newRow.insertCell(2);
          // let cell4 = newRow.insertCell(3);
          // let cell5 = newRow.insertCell(4);
          // let cell6 = newRow.insertCell(5);
          // let cell7 = newRow.insertCell(6);
          // let cell8 = newRow.insertCell(7); // Fix the index here

          // cell1.textContent = call.Caller;
          // cell2.textContent = call.dialNumber;
          // cell3.textContent = call.campaign;
          // cell4.textContent = call.startTime;
          // cell5.textContent = call.anstime;
          // cell6.textContent = call.calldisconnecttime;
          // cell7.textContent = call.agent;

          const calldata = [
            call.Caller,
            //call.dialNumber,
            // call.campaign,
            call.startTime,
            // call.anstime,
            call.hanguptime,
            call.duration,
            // call.agent.split('@')[0],
            // call.Disposition?call.Disposition:"No Dispodone",
          ];
          for (i = 0; i < calldata.length; i++) {
            const cell = newRow.insertCell(i);
            cell.innerHTML = calldata[i] !== undefined ? calldata[i] : 'NA';
          }
        });
        $(document).ready(function () {
          $('#calldata').DataTable({
            dom: 'Blfrtip',
            buttons: ['copy', 'csv', 'excel', 'pdf', 'print'],
            order: [
                  [1, 'desc'] // Column index 2 (zero-based) sorted in descending order
                 ]
          });
        });
      }
      function signOut() {
        // Clear localStorage (optional)
        localStorage.removeItem('admininfo');
        localStorage.removeItem('jwtToken');
        localStorage.removeItem('didData');

        // Redirect to the desired location
        window.location.href = '/login.html';
      }
    </script>
    <!-- Vendor JS Files -->
    <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="assets/vendor/tinymce/tinymce.min.js"></script>

    <!-- Template Main JS File -->
    <script src="assets/js/main.js"></script>
  </body>
</html>
